

## nginxå¯åŠ¨è„šæœ¬
```
#!/bin/bash
NGINX=/usr/local/nginx/sbin/nginx
PID=/usr/local/nginx/logs/nginx.pid
##fun
START () {
pstree -p |grep nginx > /dev/null 2>&1
   if [ -f $PID ] && [ $? -eq 0 ]
      then
                        echo "Warnning: nginx already running"
   else
            
               if [ -f $PID ];then
                rm -rf $PID
                fi
     $NGINX
##stdin OK
             if [ $? -eq 0 ];then
              echo -e "nginx start\t\t\t\t [\033[32m OK \033[0m]"
             else
               echo -e "nginx start\t\t\t\t [\033[31m Fail \033[0m]"
             fi
   fi
}
STOP () {
pstree -p |grep nginx > /dev/null 2>&1
if [ -f $PID ] && [ $? -eq 0 ]
      then
                       killall -s QUIT nginx
#check
                  if [ $? -eq 0 ];then
                    echo -e "nginx stop\t\t\t\t [\033[32m OK \033[0m]"
                  fi
   else
             rm -rf /usr/local/nginx/logs/nginx.pid > /dev/null 2>&1
             echo -e "nginx stop\t\t\t\t [\033[31m Fail \033[0m]"
   fi
}
RESTART () {
STOP;sleep 1;START
}
RELOAD () {
if [ -f $PID ] && [ $? -eq 0 ]
      then
          killall -s HUP $NGINX
#reload check
              if [ $? -eq 0 ];then
                     echo -e "nginx reload\t\t\t\t [\033[32m OK \033[0m]"
              fi
else
         echo "Warnning: nginx stop,please start nginx"
fi
}
STATUS () {
elinks http://localhost -dump > /dev/null 2>&1
          if [ $? -eq 0 ];then
             echo "nginx running..."
          else
             echo "nging stop"
          fi
}
#main
case $1 in
start) START;;
stop) STOP;;
restart) RESTART;;
reload) RELOAD;;
status) STATUS;;
*) echo "USAGE: AVGE is start|stop|restart|reload|status";;
esac
```



## Nginxä¼˜åŒ–
```
Nginx(è¯»éŸ³engine x)æœåŠ¡å™¨ç”±äºŽæ€§èƒ½ä¼˜ç§€ç¨³å®šã€é…ç½®ç®€å•ä»¥åŠè·¨å¹³å°ï¼Œè¢«è¶Šæ¥è¶Šå¤šçš„å…¬å¸å’Œä¸ªäººæ‰€é‡‡ç”¨ï¼ŒçŽ°å·²æˆä¸ºå¸‚åœºä»½é¢ç»§Apacheä¹‹åŽçš„
ç¬¬äºŒå¤§WebæœåŠ¡å™¨ã€‚å„å¤§å°ç½‘ç«™è®ºå›åšå®¢ä¹Ÿä»‹ç»è¯´æ˜Žäº†Nginxä»Žå®‰è£…åˆ°ä¼˜åŒ–çš„å„ç§é…ç½®ã€‚ä¸è¿‡çœ‹äº†å¾ˆå¤šè¿™äº›ç›¸å…³Nginxçš„æ–‡æ¡£ä¹‹åŽï¼Œå‘çŽ°ä¸€ä¸ª
æ¯”è¾ƒå¤§çš„é—®é¢˜ï¼Œå°±æ˜¯è¿™äº›æ–‡æ¡£åŸºæœ¬ä¹Ÿå°±ä»Žä¸¤ä¸ªæ–¹é¢ç€æ‰‹ï¼Œä¸€æ˜¯ä¿®æ”¹Nginxçš„é…ç½®æ–‡ä»¶ï¼ŒäºŒæ˜¯è°ƒæ•´æ“ä½œç³»ç»Ÿçš„ç›¸å…³å†…æ ¸å‚æ•°ï¼›è€Œä¸”æ–‡æ¡£è¯´æ˜Žä¹Ÿä¸
å¤Ÿæ˜Žäº†ï¼Œç¼ºä¹æ¯”è¾ƒç³»ç»Ÿçº§åˆ«çš„ä¼˜åŒ–ã€‚æœ¬æ–‡å°†ä»ŽNginxæºç ç¼–è¯‘å®‰è£…å¼€å§‹ï¼Œåˆ°ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œè°ƒæ•´ç³»ç»Ÿå†…æ ¸å‚æ•°ä»¥åŠæž¶æž„å››ä¸ªæ–¹é¢ç€æ‰‹åˆ†åˆ«ä»‹ç»å¦‚ä½•ä¼˜åŒ–ã€‚
ä¸€.     å®‰è£…
(1)  ç²¾ç®€æ¨¡å—
Nginxç”±äºŽä¸æ–­æ·»åŠ æ–°çš„åŠŸèƒ½ï¼Œé™„å¸¦çš„æ¨¡å—ä¹Ÿè¶Šæ¥è¶Šå¤šã€‚å¾ˆå¤šæ“ä½œç³»ç»ŸåŽ‚å•†ä¸ºäº†ç”¨æˆ·æ–¹ä¾¿å®‰è£…ç®¡ç†ï¼Œéƒ½å¢žåŠ äº†rpmã€debæˆ–è€…å…¶ä»–è‡ªæœ‰æ ¼å¼
è½¯ä»¶åŒ…ï¼Œå¯ä»¥æœ¬åœ°ç”šè‡³åœ¨çº¿å®‰è£…ã€‚ä¸è¿‡æˆ‘ä¸å¤ªå»ºè®®ä½¿ç”¨è¿™ç§å®‰è£…æ–¹å¼ã€‚è¿™è™½ç„¶ç®€åŒ–äº†å®‰è£…ï¼Œåœ¨çº¿å®‰è£…ç”šè‡³å¯ä»¥è‡ªåŠ¨è§£å†³è½¯ä»¶ä¾èµ–å…³ç³»ï¼Œä½†æ˜¯
å®‰è£…åŽè½¯ä»¶çš„æ–‡ä»¶å¸ƒå±€è¿‡äºŽåˆ†æ•£ï¼Œä¸ä¾¿ç®¡ç†ç»´æŠ¤ï¼›åŒæ—¶ä¹Ÿæ­£æ˜¯ç”±äºŽå­˜åœ¨è½¯ä»¶åŒ…ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå¯¼è‡´å½“æœ‰å®‰å…¨æ¼æ´žã€æˆ–è€…å…¶å®ƒé—®é¢˜ï¼Œæƒ³è¦
é€šè¿‡æ›´æ–°å‡çº§Nginxæ–°ç‰ˆæœ¬æ—¶å´å‘çŽ°yumã€debæºè¿˜æœªå‘å¸ƒæ–°ç‰ˆæœ¬(ä¸€èˆ¬éƒ½è½åŽäºŽå®˜ç½‘å‘å¸ƒçš„è½¯ä»¶ç‰ˆæœ¬)ã€‚æœ€é‡è¦çš„æ˜¯é‡‡ç”¨éžæºç ç¼–è¯‘å®‰è£…çš„
æ–¹å¼ï¼Œé»˜è®¤ä¼šæ·»åŠ å…¥è®¸å¤šæ¨¡å—ï¼Œæ¯”å¦‚é‚®ä»¶ç›¸å…³ã€uwsgiã€memcacheç­‰ç­‰ï¼Œå¾ˆå¤šç½‘ç«™è¿è¡Œæ—¶è¿™äº›æ¨¡å—æ ¹æœ¬æœªç”¨åˆ°ï¼Œè™½ç„¶å¹³æ—¶å ç”¨çš„èµ„æºå¾ˆå°ï¼Œ
ä½†æ˜¯ä»ç„¶å¯èƒ½æ˜¯åŽ‹å¼¯éª†é©¼çš„ä¸€æ ¹ç¨»è‰ã€‚å„ç§éžå¿…éœ€æ¨¡å—é»˜è®¤å®‰è£…è¿è¡Œçš„åŒæ—¶ï¼Œä¹Ÿç»™Webç³»ç»Ÿå¸¦æ¥äº†å®‰å…¨éšæ‚£ã€‚å°½é‡ä¿æŒè½¯ä»¶çš„è½»è£…ä¸Šé˜µï¼Œ
æ˜¯æ¯ä¸ªè¿ç»´åº”å½“å°½åŠ›åšåˆ°çš„ï¼Œæ‰€ä»¥æˆ‘å»ºè®®ä¸€èˆ¬å¸¸ç”¨çš„æœåŠ¡å™¨è½¯ä»¶ä½¿ç”¨æºç ç¼–è¯‘å®‰è£…ç®¡ç†ã€‚ã€‚æˆ‘ä¸€èˆ¬ä½¿ç”¨çš„ç¼–è¯‘å‚æ•°å¦‚ä¸‹ï¼ŒPHPç›¸å…³æ¨¡å—
fastcgiè¢«ä¿ç•™ç”¨ä½œåŽæ–‡ä¼˜åŒ–è¯´æ˜Žï¼Œï¼š


./configure \
"--prefix=/App/nginx" \
"--with-http_stub_status_module" \
"--without-http_auth_basic_module" \
"--without-http_autoindex_module" \
"--without-http_browser_module" \
"--without-http_empty_gif_module" \
"--without-http_geo_module" \
"--without-http_limit_conn_module" \
"--without-http_limit_req_module" \
"--without-http_map_module" \
"--without-http_memcached_module" \
"--without-http_proxy_module" \
"--without-http_referer_module" \
"--without-http_scgi_module" \
"--without-http_split_clients_module" \
"--without-http_ssi_module" \
"--without-http_upstream_ip_hash_module" \
"--without-http_upstream_keepalive_module" \
"--without-http_upstream_least_conn_module" \
"--without-http_userid_module" \
"--without-http_uwsgi_module" \
"--without-mail_imap_module" \
"--without-mail_pop3_module" \
"--without-mail_smtp_module" \
"--without-poll_module" \
"--without-select_module" \
"--with-cc-opt='-O2'"
ç¼–è¯‘å‚æ•°æ ¹æ®ç½‘ç«™æ˜¯å¦çœŸæ­£ç”¨åˆ°çš„åŽŸåˆ™å¢žæ·»æˆ–è€…å‡å°‘ï¼Œæ¯”å¦‚æˆ‘ä»¬å…¬å¸å¦‚æžœéœ€è¦ç”¨åˆ°ssiæ¨¡å—,ä»Žè€Œèƒ½å¤Ÿå®žçŽ°è®¿é—®shtmlé¡µé¢ï¼Œå¯ä»¥å°†ç¬¬17è¡Œåˆ é™¤ï¼Œ
é‚£ä¹ˆNginxå°†é»˜è®¤å®‰è£…ã€‚å¤§å®¶å¯ä»¥é€šè¿‡è¿è¡Œ "./configure --help" æŸ¥çœ‹ç¼–è¯‘å¸®åŠ©ï¼Œå†³å®šæ˜¯å¦éœ€è¦å®‰è£…å“ªäº›æ¨¡å—ã€‚
(2)  GCCç¼–è¯‘å‚æ•°ä¼˜åŒ– [å¯é€‰é¡¹ã€‘
GCCæ€»å…±æä¾›äº†5çº§ç¼–è¯‘ä¼˜åŒ–çº§åˆ«ï¼š
-O0: æ— ä¼˜åŒ–ã€‚
-Oå’Œ-O1: ä½¿ç”¨èƒ½å‡å°‘ç›®æ ‡ä»£ç å°ºå¯¸ä»¥åŠæ‰§è¡Œæ—¶é—´å¹¶ä¸”ä¸ä¼šä½¿ç¼–è¯‘æ—¶é—´æ˜Žæ˜¾å¢žåŠ çš„ä¼˜åŒ–ã€‚åœ¨ç¼–è¯‘å¤§åž‹ç¨‹åºçš„æ—¶å€™ä¼šæ˜¾è‘—å¢žåŠ ç¼–è¯‘æ—¶å†…å­˜çš„ä½¿ç”¨ã€‚
-O2: åŒ…å«-O1çš„ä¼˜åŒ–å¹¶å¢žåŠ äº†ä¸éœ€è¦åœ¨ç›®æ ‡æ–‡ä»¶å¤§å°å’Œæ‰§è¡Œé€Ÿåº¦ä¸Šè¿›è¡ŒæŠ˜è¡·çš„ä¼˜åŒ–ã€‚ç¼–è¯‘å™¨ä¸æ‰§è¡Œå¾ªçŽ¯å±•å¼€ä»¥åŠå‡½æ•°å†…è”ã€‚æ­¤é€‰é¡¹å°†å¢žåŠ ç¼–è¯‘
æ—¶é—´å’Œç›®æ ‡æ–‡ä»¶çš„æ‰§è¡Œæ€§èƒ½ã€‚
-Os: å¯ä»¥çœ‹æˆ -O2.5ï¼Œä¸“é—¨ä¼˜åŒ–ç›®æ ‡æ–‡ä»¶å¤§å°ï¼Œæ‰§è¡Œæ‰€æœ‰çš„ä¸å¢žåŠ ç›®æ ‡æ–‡ä»¶å¤§å°çš„-O2ä¼˜åŒ–é€‰é¡¹ï¼Œå¹¶ä¸”æ‰§è¡Œä¸“é—¨å‡å°ç›®æ ‡æ–‡ä»¶å¤§å°çš„ä¼˜åŒ–é€‰é¡¹ã€‚
é€‚ç”¨äºŽç£ç›˜ç©ºé—´ç´§å¼ æ—¶ä½¿ç”¨ã€‚ä½†æœ‰å¯èƒ½æœ‰æœªçŸ¥çš„é—®é¢˜å‘ç”Ÿï¼Œå†µä¸”ç›®å‰ç¡¬ç›˜å®¹é‡å¾ˆå¤§ï¼Œå¸¸ç”¨ç¨‹åºæ— å¿…è¦ä½¿ç”¨ã€‚
-O3: æ‰“å¼€æ‰€æœ‰ -O2 çš„ä¼˜åŒ–é€‰é¡¹å¤–å¢žåŠ  -finline-functionsã€-funswitch-loopsã€-fgcse-after-reload ä¼˜åŒ–é€‰é¡¹ã€‚ç›¸å¯¹äºŽ -O2 æ€§èƒ½
å¹¶æœªæœ‰è¾ƒå¤šæé«˜ï¼Œç¼–è¯‘æ—¶é—´ä¹Ÿæœ€é•¿ï¼Œç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶ä¹Ÿæ›´å¤§æ›´å å†…å­˜ï¼Œæœ‰æ—¶æ€§èƒ½ä¸å¢žåè€Œé™ä½Žï¼Œç”šè‡³äº§ç”Ÿä¸å¯é¢„çŸ¥çš„é—®é¢˜(åŒ…æ‹¬é”™è¯¯)ï¼Œæ‰€ä»¥å¹¶ä¸
è¢«å¤§å¤šæ•°è½¯ä»¶å®‰è£…æŽ¨èï¼Œé™¤éžæœ‰ç»å¯¹æŠŠæ¡æ–¹å¯ä½¿ç”¨æ­¤ä¼˜åŒ–çº§åˆ«ã€‚
ä¿®æ”¹GCCç¼–è¯‘å‚æ•°ï¼Œæé«˜ç¼–è¯‘ä¼˜åŒ–çº§åˆ«ï¼Œæ­¤æ–¹æ³•é€‚ç”¨äºŽæ‰€æœ‰é€šè¿‡GCCç¼–è¯‘å®‰è£…çš„ç¨‹åºï¼Œä¸æ­¢Nginxã€‚ç¨³å¦¥èµ·è§ç”¨ -O2ï¼Œè¿™ä¹Ÿæ˜¯å¤§å¤šæ•°è½¯ä»¶ç¼–è¯‘æŽ¨è
çš„ä¼˜åŒ–çº§åˆ«ã€‚æŸ¥çœ‹Nginxæºç æ–‡ä»¶ auto/cc/gccï¼Œæœç´¢NGX_GCC_OPTï¼Œé»˜è®¤GCCç¼–è¯‘å‚æ•°ä¸º-Oï¼Œå¯ä»¥ç›´æŽ¥ä¿®æ”¹å†…å®¹ä¸ºNGX_GCC_OPT="-O2"æˆ–è€…
åœ¨ ./configureé…ç½®æ—¶æ·»åŠ --with-cc-opt='-O2'é€‰é¡¹ã€‚
äºŒ.      é…ç½®
åº”ç”¨æœåŠ¡å™¨çš„æ€§èƒ½ä¼˜åŒ–ä¸»è¦åœ¨åˆç†ä½¿ç”¨CPUã€å†…å­˜ã€ç£ç›˜IOå’Œç½‘ç»œIOå››ä¸ªæ–¹é¢ï¼ŒçŽ°åœ¨æˆ‘ä»¬ä»ŽNginxé…ç½®æ–‡ä»¶ nginx.conf å…¥æ‰‹è¿›è¡Œä¼˜åŒ–ï¼š
(1)  å·¥ä½œè¿›ç¨‹æ•°çš„é€‰æ‹©
æŒ‡ä»¤ï¼šworker_processes 
å®šä¹‰äº†Nginxå¯¹å¤–æä¾›webæœåŠ¡æ—¶çš„å·¥ä½œè¿›ç¨‹æ•°ã€‚æœ€ä¼˜å€¼å–å†³äºŽè®¸å¤šå› ç´ ï¼ŒåŒ…æ‹¬ï¼ˆä½†ä¸é™äºŽï¼‰CPUæ ¸å¿ƒçš„æ•°é‡ã€å­˜å‚¨æ•°æ®çš„ç¡¬ç›˜æ•°é‡åŠè´Ÿè½½æ¨¡å¼ã€‚
ä¸èƒ½ç¡®å®šçš„æ—¶å€™ï¼Œå°†å…¶è®¾ç½®ä¸ºå¯ç”¨çš„CPUå†…æ ¸æ•°å°†æ˜¯ä¸€ä¸ªå¥½çš„å¼€å§‹ï¼ˆè®¾ç½®ä¸ºâ€œautoâ€å°†å°è¯•è‡ªåŠ¨æ£€æµ‹å®ƒï¼‰ã€‚
Shellæ‰§è¡Œå‘½ä»¤  ps ax | grep "nginx: worker process" | grep -v "grep" å¯ä»¥çœ‹åˆ°è¿è¡Œä¸­çš„Nginxå·¥ä½œè¿›ç¨‹æ•°ï¼Œ
ä¸€èˆ¬å»ºè®®è®¾ç½®æˆæœåŠ¡å™¨é€»è¾‘æ ¸å¿ƒæ•°ï¼ŒShellæ‰§è¡Œå‘½ä»¤ cat /proc/cpuinfo | grep processor | wc -l å¯ä»¥æ£€æµ‹å‡ºæœåŠ¡
å™¨é€»è¾‘æ ¸å¿ƒæ€»æ•°ï¼Œå·æ‡’å¯ä»¥ç›´æŽ¥å†™autoï¼ŒNginxè‡ªé€‚åº”ã€‚
        (2)  æ˜¯å¦ç»‘å®šCPU
æŒ‡ä»¤ï¼šworker_cpu_affinity

ç»‘å®šå·¥ä½œè¿›ç¨‹åˆ°å¯¹åº”CPUæ ¸å¿ƒï¼ŒNginxé»˜è®¤æœªå¼€å¯CPUç»‘å®šã€‚ç›®å‰çš„æœåŠ¡å™¨ä¸€èˆ¬ä¸ºå¤šæ ¸CPUï¼Œå½“å¹¶å‘å¾ˆå¤§æ—¶ï¼ŒæœåŠ¡å™¨å„ä¸ªCPUçš„ä½¿ç”¨
çŽ‡å¯èƒ½å‡ºçŽ°ä¸¥é‡ä¸å‡è¡¡çš„å±€é¢ï¼Œè¿™æ—¶å€™å¯ä»¥è€ƒè™‘ä½¿ç”¨CPUç»‘å®šï¼Œä»¥è¾¾åˆ°CPUä½¿ç”¨çŽ‡ç›¸å¯¹å‡åŒ€çš„çŠ¶æ€ï¼Œå……åˆ†å‘æŒ¥å¤šæ ¸CPUçš„ä¼˜åŠ¿ã€‚
topã€htopç­‰ç¨‹åºå¯ä»¥æŸ¥çœ‹æ‰€æœ‰CPUæ ¸å¿ƒçš„ä½¿ç”¨çŽ‡çŠ¶å†µã€‚ç»‘å®šæ ·ä¾‹ï¼š

1
2
worker_processes    4;
worker_cpu_affinity 0001 0010 0100 1000;
(3)  æ‰“å¼€æ–‡ä»¶æ•°é™åˆ¶
æŒ‡ä»¤ï¼šworker_rlimit_nofile
è®¾å®šäº†æ¯ä¸ªNginxå·¥ä½œè¿›ç¨‹æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æ•°ï¼Œå—é™äºŽç³»ç»Ÿçš„ç”¨æˆ·è¿›ç¨‹æ‰“å¼€æ–‡ä»¶æ•°é™åˆ¶ï¼Œæœªè®¾ç½®åˆ™ä½¿ç”¨ç³»ç»Ÿé»˜è®¤å€¼ã€‚ç†è®ºä¸Šåº”è¯¥
è®¾ç½®ä¸ºå½“å‰Shellå¯åŠ¨è¿›ç¨‹çš„æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•°é™¤ä»¥Nginxçš„å·¥ä½œè¿›ç¨‹æ•°ã€‚ç”±äºŽNginxçš„å·¥ä½œè¿›ç¨‹æ‰“å¼€æ–‡ä»¶æ•°å¹¶ä¸ä¸€å®Œå…¨å‡åŒ€ï¼Œ
æ‰€ä»¥å¯ä»¥å°†å…¶è®¾ç½®æˆShellå¯åŠ¨è¿›ç¨‹çš„æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•°ã€‚Shellæ‰§è¡Œå‘½ä»¤ ulimit -n å¯ä»¥æŸ¥çœ‹å½“å‰ç™»å½•Shellä¼šè¯æœ€å¤§æ‰“å¼€
æ–‡ä»¶æ•°æ•°é™åˆ¶ã€‚Linuxç³»ç»Ÿç”¨æˆ·è¿›ç¨‹é»˜è®¤åŒæ—¶æ‰“å¼€æ–‡ä»¶æœ€å¤§æ•°ä¸º1024ï¼Œè¿™ä¸ªå€¼å¤ªå°ï¼Œè®¿é—®é‡ç¨å¤§å°±æŠ¥â€œtoo many open files"ã€‚
Shellæ‰§è¡Œå‘½ä»¤å…ˆä¿®æ”¹ç”¨æˆ·æ‰“å¼€æ–‡ä»¶æ•°é™åˆ¶ï¼š


echo "* - nofile 65536" >> /etc/security/limits.conf
ç„¶åŽæ·»åŠ å…¥/etc/profileå¦‚ä¸‹ä¸¤è¡Œå†…å®¹ï¼Œä¿®æ”¹æ‰€æœ‰Shellå’Œé€šè¿‡Shellå¯åŠ¨çš„è¿›ç¨‹æ‰“å¼€æ–‡ä»¶æ•°é™åˆ¶ï¼š

1
echo "ulimit -n 65536" >> /etc/profile
Shellæ‰§è¡Œå‘½ä»¤ä½¿å½“å‰Shellä¸´æ—¶ä¼šè¯ç«‹å³ç”Ÿæ•ˆï¼š

1
ulimit -n 65536
(4) æƒŠç¾¤é—®é¢˜
æŒ‡ä»¤ï¼šaccept_mutex

å¦‚æžœ accept_mutex æŒ‡ä»¤å€¼ä¸º on å¯ç”¨ï¼Œé‚£ä¹ˆå°†è½®æµå”¤é†’ä¸€ä¸ªå·¥ä½œè¿›ç¨‹æŽ¥æ”¶å¤„ç†æ–°çš„è¿žæŽ¥ï¼Œå…¶ä½™å·¥ä½œè¿›ç¨‹ç»§ç»­ä¿æŒç¡çœ ï¼›
å¦‚æžœå€¼ä¸º off å…³é—­ï¼Œé‚£ä¹ˆå°†å”¤é†’æ‰€æœ‰å·¥ä½œè¿›ç¨‹ï¼Œç”±ç³»ç»Ÿé€šè¿‡useæŒ‡ä»¤æŒ‡å®šçš„ç½‘ç»œIOæ¨¡åž‹è°ƒåº¦å†³å®šç”±å“ªä¸ªå·¥ä½œè¿›ç¨‹å¤„ç†ï¼Œ
æœªæŽ¥æ”¶åˆ°è¿žæŽ¥è¯·æ±‚çš„å·¥ä½œè¿›ç¨‹ç»§ç»­ä¿æŒç¡çœ ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€œæƒŠç¾¤é—®é¢˜â€ã€‚WebæœåŠ¡å™¨Apacheçš„è¿›ç¨‹æ•°å¾ˆå¤šï¼Œæˆç™¾ä¸Šåƒä¹Ÿæ˜¯
æ—¶æœ‰çš„äº‹ï¼Œâ€œæƒŠç¾¤é—®é¢˜â€ä¹Ÿå°¤ä¸ºæ˜Žæ˜¾ã€‚Nginxä¸ºäº†ç¨³å®šï¼Œå‚æ•°å€¼ä¿å®ˆçš„è®¾ç½®ä¸º on å¼€å¯çŠ¶æ€ã€‚å¯ä»¥å°†å…¶è®¾ç½®æˆOff æé«˜æ€§èƒ½
å’Œåžåé‡ï¼Œä½†è¿™æ ·ä¹Ÿä¼šå¸¦æ¥ä¸Šä¸‹æ–‡åˆ‡æ¢å¢žå¤šæˆ–è€…è´Ÿè½½å‡é«˜ç­‰ç­‰å…¶å®ƒèµ„æºæ›´å¤šæ¶ˆè€—çš„åŽæžœã€‚
(5)  ç½‘ç»œIOæ¨¡åž‹
æŒ‡ä»¤ï¼šuse
å®šä¹‰äº†Nginxè®¾ç½®ç”¨äºŽå¤ç”¨å®¢æˆ·ç«¯çº¿ç¨‹çš„è½®è¯¢æ–¹æ³•(ä¹Ÿå¯ç§°å¤šè·¯å¤ç”¨ç½‘ç»œIOæ¨¡åž‹)ã€‚è¿™è‡ªç„¶æ˜¯é€‰æ‹©æ•ˆçŽ‡æ›´é«˜çš„ä¼˜å…ˆï¼ŒLinux 2.6+å†…
æ ¸æŽ¨èä½¿ç”¨epollï¼ŒFreeBSDæŽ¨èä½¿ç”¨kqueueï¼Œå®‰è£…æ—¶Nginxä¼šè‡ªåŠ¨é€‰æ‹©ã€‚
(6)  è¿žæŽ¥æ•°
æŒ‡ä»¤ï¼šworker_connections
å®šä¹‰äº†Nginxä¸€ä¸ªå·¥ä½œè¿›ç¨‹çš„æœ€å¤§åŒæ—¶è¿žæŽ¥æ•°ï¼Œä¸ä»…é™äºŽå®¢æˆ·ç«¯è¿žæŽ¥ï¼ŒåŒ…æ‹¬äº†å’ŒåŽç«¯è¢«ä»£ç†æœåŠ¡å™¨ç­‰å…¶ä»–çš„è¿žæŽ¥ã€‚å®˜ç½‘æ–‡æ¡£è¿˜æŒ‡å‡º
äº†è¯¥å‚æ•°å€¼ä¸èƒ½è¶…è¿‡ worker_rlimit_nofile å€¼ï¼Œæ‰€ä»¥å»ºè®®è®¾ç½®æˆå’Œ worker_rlimit_nofile å€¼ç›¸ç­‰ã€‚
(7)  æ‰“å¼€æ–‡ä»¶ç¼“å­˜
æŒ‡ä»¤ï¼šopen_file_cache

å¼€å¯å…³é—­æ‰“å¼€æ–‡ä»¶ç¼“å­˜ï¼Œé»˜è®¤å€¼ off å…³é—­ï¼Œå¼ºçƒˆå»ºè®®å¼€å¯ï¼Œå¯ä»¥é¿å…é‡æ–°æ‰“å¼€åŒä¸€æ–‡ä»¶å¸¦æ¥çš„ç³»ç»Ÿå¼€é”€ï¼ŒèŠ‚çœå“åº”æ—¶é—´ã€‚å¦‚éœ€å¼€å¯å¿…é¡»
åŽæŽ¥å‚æ•° max=æ•°å­—ï¼Œè®¾ç½®ç¼“å­˜å…ƒç´ çš„æœ€å¤§æ•°é‡ã€‚å½“ç¼“å­˜æº¢å‡ºæ—¶ï¼Œä½¿ç”¨LRU(æœ€è¿‘æœ€å°‘ä½¿ç”¨)ç®—æ³•åˆ é™¤ç¼“å­˜ä¸­çš„å…ƒç´ ï¼›å¯é€‰å‚æ•° inactive=
æ—¶é—´ è®¾ç½®è¶…æ—¶ï¼Œåœ¨è¿™æ®µæ—¶é—´å†…ç¼“å­˜å…ƒç´ å¦‚æžœæ²¡æœ‰è¢«è®¿é—®ï¼Œå°†ä»Žç¼“å­˜ä¸­åˆ é™¤ã€‚ç¤ºä¾‹ï¼šopen_file_cache max=65536  inactive=60sã€‚
æŒ‡ä»¤ï¼šopen_file_cache_valid
è®¾ç½®æ£€æŸ¥open_file_cacheç¼“å­˜çš„å…ƒç´ çš„æ—¶é—´é—´éš”ã€‚
æŒ‡ä»¤ï¼šopen_file_cache_min_uses
è®¾ç½®åœ¨ç”±open_file_cacheæŒ‡ä»¤çš„inactiveå‚æ•°é…ç½®çš„è¶…æ—¶æ—¶é—´å†…ï¼Œ æ–‡ä»¶åº”è¯¥è¢«è®¿é—®çš„æœ€å°æ¬¡æ•°ã€‚å¦‚æžœè®¿é—®æ¬¡æ•°å¤§äºŽç­‰äºŽæ­¤å€¼ï¼Œæ–‡ä»¶æ
è¿°ç¬¦ä¼šä¿ç•™åœ¨ç¼“å­˜ä¸­ï¼Œå¦åˆ™ä»Žç¼“å­˜ä¸­åˆ é™¤ã€‚
(8)  æ—¥å¿—ç›¸å…³
æŒ‡ä»¤ï¼šaccess_log å’Œ error_log
å½“å¹¶å‘å¾ˆå¤§æ—¶ï¼ŒNginxçš„è®¿é—®æ—¥å¿—å’Œé”™è¯¯æ—¥å¿—çš„ä¿å­˜è‚¯å®šä¼šé€ æˆå¯¹ç£ç›˜çš„å¤§é‡è¯»å†™ï¼Œä¹Ÿå°†å½±å“Nginxçš„æ€§èƒ½ã€‚å¹¶å‘é‡è¶Šå¤§ï¼ŒIOè¶Šé«˜ã€‚è¿™æ—¶å€™
å¯ä»¥è€ƒè™‘å…³é—­è®¿é—®æ—¥å¿—å’Œé”™è¯¯æ—¥å¿—ï¼Œæˆ–è€…å°†æ—¥å¿—ä¿å­˜åˆ°tmpfsæ–‡ä»¶ç³»ç»Ÿé‡Œï¼Œæˆ–è€…å‡å°‘ä¿å­˜çš„è®¿é—®æ—¥å¿—æ¡ç›®å’Œé”™è¯¯æ—¥å¿—çš„çº§åˆ«ï¼Œä»Žè€Œé¿å…ç£ç›˜
IOçš„å½±å“ã€‚å…³é—­æ—¥å¿—ä½¿ç”¨ access_log offã€‚å¦‚å¿…é¡»ä¿å­˜æ—¥å¿—ï¼Œå¯ä»¥æŒ‰æ¯æ—¥æˆ–è€…æ¯æ—¶æˆ–è€…å…¶å®ƒæ—¶é—´æ®µå¯¹æ—¥å¿—åšåˆ‡å‰²ï¼Œè¿™ä¹Ÿå¯ä»¥å‡å°IOï¼Œ
è™½ç„¶å¯èƒ½æ•ˆæžœä¸æ˜¯ç‰¹åˆ«å¤§ï¼Œä¸è¿‡å› ä¸ºæ—¥å¿—æ–‡ä»¶å°ºå¯¸å˜å°äº†å¾ˆå¤šï¼Œä¹Ÿæ–¹ä¾¿æŸ¥é˜…æˆ–å½’æ¡£åˆ†æžæ—¥å¿—ã€‚ä¸€èˆ¬çº¿ä¸ŠçŽ¯å¢ƒå»ºè®®é”™è¯¯æ—¥å¿—è®¾ç½®ä¸º error 
æˆ–è€… critã€‚è‡ªå®šä¹‰è®¿é—®æ—¥å¿—çš„æ¡ç›®å’Œé”™è¯¯æ—¥å¿—çš„çº§åˆ«ï¼Œè¯¦ç»†ä¿¡æ¯å¯ä»¥å‚é˜…å®˜ç½‘æˆ–è€…ç½‘ä¸Šå…¶å®ƒæ–‡æ¡£ï¼ŒæŒ‰éœ€ä¿®æ”¹ã€‚
(9)  éšè—Nginxç‰ˆæœ¬å·
æŒ‡ä»¤ï¼šserver_tokens
å¼€å¯æˆ–å…³é—­â€œServerâ€å“åº”å¤´ä¸­è¾“å‡ºçš„Nginxç‰ˆæœ¬å·ã€‚æŽ¨ä»‹è®¾ç½®ä¸º offï¼Œå…³é—­æ˜¾ç¤ºå“åº”å¤´çš„ç‰ˆæœ¬å·ï¼Œå¯¹æ€§èƒ½çš„æé«˜æœ‰å°å°çš„è£¨ç›Šï¼Œä¸»è¦è¿˜æ˜¯
ä¸ºäº†å®‰å…¨èµ·è§ï¼Œä¸è¢«éª‡å®¢æ‰¾åˆ°ç‰ˆæœ¬å·å¯¹åº”çš„æ¼æ´žï¼Œä»Žè€Œè¢«æ”»å‡»ã€‚
(10) åŽ‹ç¼©ç›¸å…³
æŒ‡ä»¤ï¼šgzip
Nginxé»˜è®¤å¼€å¯äº†gzipåŽ‹ç¼©åŠŸèƒ½ã€‚æœ‰å¯èƒ½å¾ˆå¤šäººè®¤ä¸ºï¼Œå¼€å¯gzipåŽ‹ç¼©ä¼šå¢žåŠ CPUçš„å¤„ç†æ—¶é—´å’Œè´Ÿè½½ã€‚ä½†æ˜¯ç»è¿‡æˆ‘ä»¬ç½‘ç«™çš„æµ‹è¯•å‘çŽ°ï¼Œå…³é—­äº†
gzipåŽ‹ç¼©åŠŸèƒ½çš„Nginxè™½ç„¶å‡å°‘äº†CPUè®¡ç®—ï¼ŒèŠ‚çœäº†æœåŠ¡å™¨çš„å“åº”æ—¶é—´ï¼Œä½†ç½‘ç«™é¡µé¢æ€»ä½“å“åº”æ—¶é—´åè€ŒåŠ é•¿äº†ï¼ŒåŽŸå› åœ¨äºŽjså’Œcssã€xmlã€j

sonã€htmlç­‰ç­‰è¿™äº›é™æ€æ–‡ä»¶çš„æ•°æ®ä¼ è¾“æ—¶é—´çš„å¢žé•¿å¤§å¤§è¶…è¿‡äº†æœåŠ¡å™¨èŠ‚çœå‡ºæ¥çš„å“åº”æ—¶é—´ï¼Œå¾—ä¸å¿å¤±ã€‚gzip on å¼€å¯åŽ‹ç¼©åŽï¼Œå¤§çº¦å¯ä»¥å‡

å°‘75%çš„æ–‡ä»¶å°ºå¯¸ï¼Œä¸ä½†èŠ‚çœäº†æ¯”è¾ƒå¤šçš„å¸¦å®½æµé‡ï¼Œä¹Ÿæé«˜äº†é¡µé¢çš„æ•´ä½“å“åº”æ—¶é—´ã€‚æ‰€æœ‰å»ºè®®è¿˜æ˜¯å¼€å¯ã€‚å½“ç„¶ä¹Ÿä¸æ˜¯æ‰€æœ‰çš„é™æ€æ–‡ä»¶éƒ½éœ€è¦åŽ‹
ç¼©ï¼Œæ¯”å¦‚é™æ€å›¾ç‰‡å’ŒPDFã€è§†é¢‘ï¼Œæ–‡ä»¶æœ¬èº«å°±åº”å½“åšåŽ‹ç¼©å¤„ç†åŽä¿å­˜åˆ°æœåŠ¡å™¨ã€‚è¿™äº›æ–‡ä»¶å†æ¬¡ä½¿ç”¨gzipåŽ‹ç¼©ï¼ŒåŽ‹ç¼©çš„æ¯”ä¾‹å¹¶ä¸é«˜ï¼Œç”šè‡³é€‚å¾—å…¶
åï¼ŒåŽ‹ç¼©åŽæ–‡ä»¶å°ºå¯¸å¢žå¤§äº†ã€‚CPUåŽ‹ç¼©å¤„ç†è¿™äº›é™æ€æ–‡ä»¶å¢žåŠ å ç”¨çš„æœåŠ¡å™¨å“åº”æ—¶é—´ç»å¤§éƒ¨åˆ†æ—¶å€™ä¼šè¶…è¿‡äº†è¢«åŽ‹ç¼©å‡å°çš„æ–‡ä»¶å°ºå¯¸å‡å°‘çš„æ•°æ®
ä¼ è¾“æ—¶é—´ï¼Œä¸åˆ’ç®—ã€‚æ˜¯å¦éœ€è¦å¯¹Webç½‘ç«™å¼€å¯åŽ‹ç¼©ï¼Œä»¥åŠå¯¹å“ªäº›æ–‡ä»¶è¿‡æ»¤åŽ‹ç¼©ï¼Œå¤§å®¶å¯ä»¥é€šè¿‡ä½¿ç”¨HttpWatchã€Firebugç­‰ç­‰ç½‘ç»œåˆ†æžå·¥å…·å¯¹æ¯”æµ‹è¯•ã€‚
æŒ‡ä»¤ï¼šgzip_comp_level
æŒ‡å®šåŽ‹ç¼©ç­‰çº§ï¼Œå…¶å€¼ä»Ž1åˆ°9ï¼Œæ•°å­—è¶Šå¤§ï¼ŒåŽ‹ç¼©çŽ‡è¶Šé«˜ï¼Œè¶Šæ¶ˆè€—CPUï¼Œè´Ÿè½½ä¹Ÿè¶Šé«˜ã€‚9ç­‰çº§æ— ç–‘åŽ‹ç¼©çŽ‡æœ€é«˜ï¼ŒåŽ‹ç¼©åŽçš„æ–‡ä»¶å°ºå¯¸ä¹Ÿæœ€å°ï¼Œä½†ä¹Ÿæ˜¯
æœ€è€—CPUèµ„æºï¼Œè´Ÿè½½æœ€é«˜ï¼Œé€Ÿåº¦æœ€æ…¢çš„ï¼Œè¿™å¯¹äºŽç”¨æˆ·è®¿é—®æœ‰æ—¶æ˜¯æ— æ³•å¿å—çš„ã€‚ä¸€èˆ¬æŽ¨èä½¿ç”¨1-4ç­‰çº§ï¼Œæ¯”è¾ƒæŠ˜è¡·çš„æ–¹æ¡ˆã€‚æˆ‘ä»¬å…¬å¸ç½‘ç«™ä½¿ç”¨ç­‰çº§2ã€‚
æŒ‡ä»¤ï¼šgzip_min_length
æŒ‡å®šåŽ‹ç¼©çš„æ–‡ä»¶æœ€å°å°ºå¯¸ï¼Œå•ä½ bytes å­—èŠ‚ï¼Œä½ŽäºŽè¯¥å€¼çš„ä¸åŽ‹ç¼©ï¼Œè¶…è¿‡è¯¥å€¼çš„å°†è¢«åŽ‹ç¼©ã€‚æˆ‘ä»¬ç½‘ç«™è®¾ç½®ä¸º1kï¼Œå¤ªå°çš„æ–‡ä»¶æ²¡å¿…è¦åŽ‹ç¼©ï¼ŒåŽ‹ç¼©
è¿‡å°å°ºå¯¸æ–‡ä»¶å¸¦æ¥å¢žåŠ çš„CPUæ¶ˆè€—æ—¶é—´å’ŒåŽ‹ç¼©å‡å°‘çš„æ–‡ä»¶å°ºå¯¸é™ä½Žçš„æ•°æ®ä¸‹è½½æ—¶é—´äº’ç›¸æŠµæ¶ˆï¼Œå¹¶æœ‰å¯èƒ½å¢žåŠ æ€»ä½“çš„å“åº”æ—¶é—´ã€‚
æŒ‡ä»¤ï¼šgzip_types
æŒ‡å®šå…è®¸åŽ‹ç¼©çš„æ–‡ä»¶ç±»åž‹ï¼ŒNginxé…ç½®ç›®å½• conf ä¸‹çš„ mime.types æ–‡ä»¶å­˜æ”¾äº†Nginxæ”¯æŒçš„æ–‡ä»¶ç±»åž‹ï¼Œtext/htmlç±»åž‹æ–‡ä»¶ï¼Œæ–‡ä»¶åŽç¼€ä¸º
html htm shtmlé»˜è®¤åŽ‹ç¼©ã€‚æŽ¨èé…ç½®ï¼šgzip_types text/plain text/css application/json application/x-javascript text/xml
 application/xml application/xml+rss text/javascriptã€‚
(11) æµè§ˆå™¨ç¼“å­˜
æŒ‡ä»¤ï¼šexpires
è®¾ç½®HTTPåº”ç­”ä¸­çš„â€œExpiresâ€å’Œâ€œCache-Controlâ€å¤´æ ‡ã€‚"Expires"ä¸€èˆ¬ç»“åˆ"Last-Modified"ä½¿ç”¨ã€‚å½“è®¾ç½®äº†åˆç†çš„expiresé…ç½®æ—¶ï¼Œ
æµè§ˆå™¨ç¬¬ä¸€æ¬¡è®¿é—®Webé¡µé¢å…ƒç´ ï¼Œä¼šä¸‹è½½é¡µé¢ä¸­çš„çš„é™æ€æ–‡ä»¶åˆ°æœ¬æœºä¸´æ—¶ç¼“å­˜ç›®å½•ä¸‹ã€‚ç¬¬äºŒæ¬¡åŠä¹‹åŽå†æ¬¡è®¿é—®ç›¸åŒURLæ—¶å°†å‘é€å¸¦å¤´æ ‡è¯†
"If-Modified-Since"å’Œæœ¬åœ°ç¼“å­˜æ–‡ä»¶æ—¶é—´å±žæ€§å€¼çš„è¯·æ±‚ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ¯”å¯¹æœåŠ¡å™¨æœ¬åœ°æ–‡ä»¶æ—¶é—´å±žæ€§å€¼ï¼Œå¦‚æžœæœªä¿®æ”¹ï¼ŒæœåŠ¡å™¨ç›´æŽ¥
è¿”å›žhttp 304çŠ¶æ€ç ï¼Œæµè§ˆå™¨ç›´æŽ¥è°ƒç”¨æœ¬åœ°å·²ç¼“å­˜çš„æ–‡ä»¶ï¼›å¦‚æžœæ—¶é—´å±žæ€§å€¼ä¿®æ”¹äº†ï¼Œé‡æ–°å‘é€æ–°æ–‡ä»¶ã€‚è¿™æ ·å°±é¿å…äº†ä»ŽæœåŠ¡å™¨å†æ¬¡ä¼ é€
æ–‡ä»¶å†…å®¹ï¼Œå‡å°äº†æœåŠ¡å™¨åŽ‹åŠ›ï¼ŒèŠ‚çœäº†å¸¦å®½ï¼ŒåŒæ—¶ä¹Ÿæé«˜äº†ç”¨æˆ·è®¿é—®é€Ÿåº¦ï¼Œä¸€ä¸¾ä¸‰å¾—ã€‚æŒ‡ä»¤åŽæŽ¥æ•°å­—åŠ æ—¶é—´å•ä½ï¼Œå³ä¸ºç¼“å­˜è¿‡æœŸæ—¶é—´ï¼›-1 
è¡¨ç¤ºæ°¸è¿œè¿‡æœŸï¼Œä¸ç¼“å­˜ã€‚å¼ºçƒˆå»ºè®®æ·»åŠ expiresé…ç½®ï¼Œè¿‡æœŸæ—¶é—´çš„é€‰æ‹©å…·ä½“åˆ†æžã€‚æˆ‘ä»¬å…¬å¸çš„éƒ¨åˆ†Nginxé…ç½®å¦‚ä¸‹ï¼š


location ~ .+\.(gif|jpg|jpeg|png|bmp|swf)$
{
    expires 30d;
}

location ~ .+\.(js|css|xml|javascript|txt|csv)$
{
    expires 30d;
}
æˆ–è€…ç»Ÿä¸€å°†é™æ€æ–‡ä»¶æ”¾åœ¨å›ºå®šç›®å½•ä¸‹å†å¯¹ç›®å½•åšlocationå’Œexpiresï¼Œç¤ºä¾‹ï¼š

location /static/
{
    expires 30d;
}
(12) æŒä¹…è¿žæŽ¥
æŒ‡ä»¤ï¼škeepalive_timeout
å¯ç”¨Httpçš„æŒä¹…è¿žæŽ¥Keepaliveå±žæ€§ï¼Œå¤ç”¨ä¹‹å‰å·²å»ºç«‹çš„TCPè¿žæŽ¥æŽ¥æ”¶è¯·æ±‚ã€å‘é€å›žåº”ï¼Œå‡å°‘é‡æ–°å»ºç«‹TCPè¿žæŽ¥çš„èµ„æºæ—¶é—´å¼€é”€ã€‚
åœ¨æ­¤çš„å»ºè®®æ˜¯å½“ç½‘ç«™é¡µé¢å†…å®¹ä»¥é™æ€ä¸ºä¸»æ—¶ï¼Œå¼€å¯æŒä¹…è¿žæŽ¥ï¼›è‹¥ä¸»è¦æ˜¯åŠ¨æ€ç½‘é¡µï¼Œä¸”ä¸èƒ½è¢«è½¬åŒ–ä¸ºé™æ€é¡µé¢ï¼Œåˆ™å…³é—­æŒä¹…è¿žæŽ¥ã€‚
åŽæŽ¥æ•°å­—å’Œæ—¶é—´å•ä½ç¬¦å·ã€‚æ­£æ•°ä¸ºå¼€å¯æŒä¹…è¿žæŽ¥ï¼Œ0å…³é—­ã€‚
(13) å‡å°‘HTTPè¯·æ±‚æ¬¡æ•°
ç½‘ç«™é¡µé¢ä¸­å­˜åœ¨å¤§é‡çš„å›¾ç‰‡ã€è„šæœ¬ã€æ ·å¼è¡¨ã€Flashç­‰é™æ€å…ƒç´ ï¼Œå‡å°‘è®¿é—®è¯·æ±‚æ¬¡æ•°æœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯å‡å°‘ç”¨æˆ·é¦–æ¬¡è®¿é—®é¡µé¢çš„åŠ è½½
æ—¶é—´ã€‚å¯ä»¥é‡‡ç”¨åˆå¹¶ç›¸åŒç±»åž‹æ–‡ä»¶ä¸ºä¸€ä¸ªæ–‡ä»¶çš„åŠžæ³•å‡å°‘è¯·æ±‚æ¬¡æ•°ã€‚è¿™å…¶å®žå±žäºŽWebå‰ç«¯ä¼˜åŒ–èŒƒç•´ï¼Œåº”å½“ç”±Webå‰æ®µå·¥ç¨‹å¸ˆåšå¥½ç›¸
å…³é™æ€æ–‡ä»¶çš„è§„åˆ’ç®¡ç†ï¼Œè€Œä¸æ˜¯ç”±è¿ç»´æ¥åšã€‚ä¸è¿‡Nginxä¹Ÿå¯ä»¥é€šè¿‡å®‰è£…é˜¿é‡Œå·´å·´æä¾›çš„Concatæˆ–è€…Googleçš„PageSpeedæ¨¡å—å®ž
çŽ°è¿™ä¸ªåˆå¹¶æ–‡ä»¶çš„åŠŸèƒ½ã€‚æˆ‘ä»¬å…¬å¸å¹¶æœªä½¿ç”¨åˆå¹¶åŠŸèƒ½ï¼Œå…·ä½“å®‰è£…é…ç½®ä¿¡æ¯è¯·æŸ¥è¯¢ç½‘ä¸Šç›¸å…³æ–‡æ¡£ï¼Œè¿™é‡Œä¸å†ç´¯è¿°ã€‚Concatæºä»£ç ç½‘
å€ï¼šhttps://github.com/alibaba/nginx-http-concat/ï¼ŒPageSpeedæºä»£ç ç½‘å€ï¼šhttps://github.com/pagespeed/ngx_pagespeedã€‚
(14) PHPç›¸å…³
Nginxä¸èƒ½ç›´æŽ¥è§£æžPHPä»£ç æ–‡ä»¶ï¼Œéœ€è¦è°ƒç”¨FastCGIæŽ¥å£è½¬ç»™PHPè§£é‡Šå™¨æ‰§è¡Œï¼Œç„¶åŽå°†ç»“æžœè¿”å›žç»™Nginxã€‚PHPä¼˜åŒ–æœ¬æ–‡æš‚ä¸ä»‹ç»ã€‚
Nginxå¯ä»¥å¼€å¯FastCGIçš„ç¼“å­˜åŠŸèƒ½ï¼Œä»Žè€Œæé«˜æ€§èƒ½ã€‚
æŒ‡ä»¤ï¼šfastcgi_temp_path
å®šä¹‰FastCGIç¼“å­˜æ–‡ä»¶ä¿å­˜ä¸´æ—¶è·¯å¾„ã€‚
æŒ‡ä»¤ï¼šfastcgi_cache_path
å®šä¹‰FastCGIç¼“å­˜æ–‡ä»¶ä¿å­˜è·¯å¾„å’Œç¼“å­˜çš„å…¶å®ƒå‚æ•°ã€‚ç¼“å­˜æ•°æ®ä»¥äºŒè¿›åˆ¶æ•°æ®æ–‡ä»¶å½¢å¼å­˜å‚¨ï¼Œç¼“å­˜æ–‡ä»¶åå’Œkeyéƒ½æ˜¯é€šè¿‡å¯¹è®¿é—®URLä½¿ç”¨
MD5è®¡ç®—èŽ·å¾—çš„ç»“æžœã€‚ç¼“å­˜æ–‡ä»¶å…ˆä¿å­˜è‡³fastcgi_temp_pathæŒ‡å®šçš„ä¸´æ—¶ç›®å½•ä¸‹ï¼Œç„¶åŽé€šè¿‡é‡å‘½åæ“ä½œç§»è‡³fastcgi_cache_pathæŒ‡
å®šçš„ç¼“å­˜ç›®å½•ã€‚levelsæŒ‡å®šäº†ç›®å½•ç»“æž„,å­ç›®å½•æ•°ä»¥16ä¸ºåŸºæ•°ï¼›keys_zoneæŒ‡å®šäº†å…±äº«å†…å­˜åŒºåå’Œå¤§å°ï¼Œç”¨äºŽä¿å­˜ç¼“å­˜keyå’Œæ•°æ®ä¿¡æ¯ï¼›
inactiveæŒ‡å®šäº†ç¼“å­˜æ•°æ®ä¿å­˜çš„æ—¶é—´ï¼Œå½“è¿™æ®µæ—¶é—´å†…æœªè¢«è®¿é—®ï¼Œå°†è¢«ç§»å‡ºï¼›max_sizeæŒ‡å®šäº†ç¼“å­˜ä½¿ç”¨çš„æœ€å¤§ç£ç›˜ç©ºé—´ï¼Œè¶…è¿‡å®¹é‡æ—¶å°†
æœ€è¿‘æœ€å°‘ä½¿ç”¨æ•°æ®åˆ é™¤ã€‚å»ºè®®fastcgi_temp_pathå’Œfastcgi_cache_pathè®¾ä¸ºåŒä¸€åˆ†åŒºï¼ŒåŒåˆ†åŒºç§»åŠ¨æ“ä½œæ•ˆçŽ‡æ›´é«˜ã€‚ç¤ºä¾‹ï¼š


fastcgi_temp_path /tmp/fastcgi_temp;
fastcgi_cache_path /tmp/fastcgi_cache levels=1:2 keys_zone=cache_fastcgi:16m inactive=30m max_size=1g;
ç¤ºä¾‹ä¸­ä½¿ç”¨/tmp/fastcgi_tempä½œä¸ºFastCGIç¼“å­˜çš„ä¸´æ—¶ç›®å½•ï¼›/tmp/fastcgi_cacheä½œä¸ºFastCGIç¼“å­˜ä¿å­˜çš„æœ€ç»ˆç›®å½•ï¼›ä¸€çº§å­ç›®å½•ä¸º
16çš„ä¸€æ¬¡æ–¹16ä¸ªï¼ŒäºŒçº§å­ç›®å½•ä¸º16çš„2æ¬¡æ–¹256ä¸ªï¼›å…±äº«å†…å­˜åŒºåä¸ºcache_fastcgiï¼Œå ç”¨å†…å­˜128MBï¼›ç¼“å­˜è¿‡æœŸæ—¶é—´ä¸º30åˆ†é’Ÿï¼›ç¼“å­˜æ•°æ®
ä¿å­˜äºŽç£ç›˜çš„æœ€å¤§ç©ºé—´å¤§å°ä¸º1GBã€‚
æŒ‡ä»¤ï¼šfastcgi_cache_key
å®šä¹‰FastCGIç¼“å­˜å…³é”®å­—ã€‚å¯ç”¨FastCGIç¼“å­˜å¿…é¡»åŠ ä¸Šè¿™ä¸ªé…ç½®ï¼Œä¸ç„¶è®¿é—®æ‰€æœ‰PHPçš„è¯·æ±‚éƒ½ä¸ºè®¿é—®ç¬¬ä¸€ä¸ªPHPæ–‡ä»¶URLçš„ç»“æžœã€‚
 æŒ‡ä»¤ï¼šfastcgi_cache_valid
ä¸ºæŒ‡å®šçš„HttpçŠ¶æ€ç æŒ‡å®šç¼“å­˜æ—¶é—´ã€‚
æŒ‡ä»¤ï¼šfastcgi_cache_min_uses
æŒ‡å®šç»è¿‡å¤šå°‘æ¬¡è¯·æ±‚ç›¸åŒçš„URLå°†è¢«ç¼“å­˜ã€‚
æŒ‡ä»¤ï¼šfastcgi_cache_use_stale
æŒ‡å®šå½“è¿žæŽ¥FastCGIæœåŠ¡å™¨å‘ç”Ÿé”™è¯¯æ—¶ï¼Œå“ªäº›æƒ…å†µä½¿ç”¨è¿‡æœŸæ•°æ®å›žåº”ã€‚
æŒ‡ä»¤ï¼šfastcgi_cache
ç¼“å­˜ä½¿ç”¨å“ªä¸ªå…±äº«å†…å­˜åŒºã€‚
æˆ‘å¸¸ç”¨nginx.confæ¨¡æ¿ï¼Œå¤§å®¶æ ¹æ®æƒ…å†µåšé€‚å½“ä¿®æ”¹ï¼š


user  nginx nginx;
worker_processes  auto;

error_log  logs/error.log error;

pid        logs/nginx.pid;
worker_rlimit_nofile    65536;

events
{
    use epoll;
    accept_mutex off;
    worker_connections  65536;
}


http
{
    include       mime.types;
    default_type  text/html;

    charset UTF-8;
    server_names_hash_bucket_size 128;
    client_header_buffer_size 4k;
    large_client_header_buffers 4 32k;
    client_max_body_size            8m;

    open_file_cache max=65536  inactive=60s;
    open_file_cache_valid      80s;
    open_file_cache_min_uses   1;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  logs/access.log  main;

    sendfile    on;
    server_tokens off;

    fastcgi_temp_path  /tmp/fastcgi_temp;
    fastcgi_cache_path /tmp/fastcgi_cache levels=1:2 keys_zone=cache_fastcgi:128m inactive=30m max_size=1g;
    fastcgi_cache_key $request_method://$host$request_uri;
    fastcgi_cache_valid 200 302 1h;
    fastcgi_cache_valid 301     1d;
    fastcgi_cache_valid any     1m;
    fastcgi_cache_min_uses 1;
    fastcgi_cache_use_stale error timeout http_500 http_503 invalid_header;

    keepalive_timeout  60;

    gzip  on;
    gzip_min_length 1k;
    gzip_buffers  4 64k;
    gzip_http_version 1.1;
    gzip_comp_level 2;
    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/
    xml+rss text/javascript;

    server
    {
        listen       80;
        server_name  localhost;
        index        index.html;
        root         /App/web;

        location ~ .+\.(php|php5)$
        {
            fastcgi_pass   unix:/tmp/php.sock;
            fastcgi_index  index.php;
            include        fastcgi.conf;
            fastcgi_cache  cache_fastcgi;
        }

        location ~ .+\.(gif|jpg|jpeg|png|bmp|swf|txt|csv|doc|docx|xls|xlsx|ppt|pptx|flv)$
        {
            expires 30d;
        }

        location ~ .+\.(js|css|html|xml)$
        {
            expires 30d;
        }

        location /nginx-status
        {
            stub_status on;
            allow 192.168.1.0/24;
            allow 127.0.0.1;
            deny all;
        }
    }
}
ä¸‰.        å†…æ ¸
Linuxå†…æ ¸å‚æ•°éƒ¨åˆ†é»˜è®¤å€¼ä¸é€‚åˆé«˜å¹¶å‘ï¼Œä¸€èˆ¬ä¸´æ—¶æ–¹æ³•å¯ä»¥é€šè¿‡è°ƒæ•´/Procæ–‡ä»¶ç³»ç»Ÿï¼Œæˆ–è€…ç›´æŽ¥ä¿®æ”¹/etc/sysctl.confé…ç½®æ–‡ä»¶æ°¸ä¹…ä¿å­˜ã€‚
è°ƒæ•´/Procæ–‡ä»¶ç³»ç»Ÿï¼Œç³»ç»Ÿé‡å¯åŽè¿˜åŽŸè‡³é»˜è®¤å€¼ï¼Œæ‰€ä»¥ä¸æŽ¨èã€‚Linuxå†…æ ¸è°ƒä¼˜ï¼Œä¸»è¦æ¶‰åŠåˆ°ç½‘ç»œå’Œæ–‡ä»¶ç³»ç»Ÿã€å†…å­˜ç­‰çš„ä¼˜åŒ–ï¼Œä¸‹é¢æ˜¯æˆ‘å¸¸ç”¨
çš„å†…æ ¸è°ƒä¼˜é…ç½®ï¼š


grep -q "net.ipv4.tcp_max_tw_buckets" /etc/sysctl.conf || cat >> /etc/sysctl.conf << EOF
########################################
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216
net.core.somaxconn = 262144
net.core.netdev_max_backlog = 262144
net.ipv4.tcp_max_orphans = 262144
net.ipv4.tcp_max_syn_backlog = 262144
net.ipv4.tcp_max_tw_buckets = 10000
net.ipv4.ip_local_port_range = 1024 65500
net.ipv4.tcp_tw_recycle = 1
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_synack_retries = 1
net.ipv4.tcp_syn_retries = 1
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_mem = 786432 1048576 1572864
fs.aio-max-nr = 1048576
fs.file-max = 6815744
kernel.sem = 250 32000 100 128
vm.swappiness = 10
EOF
sysctl -p
è¯¦ç»†è¯´æ˜Žå¤§å®¶å¯ä»¥æŸ¥çœ‹æˆ‘çš„Linuxå†…æ ¸ä¼˜åŒ–æ–‡ç« ï¼šhttp://dongsong.blog.51cto.com/916653/1631085ã€‚
å››.        æž¶æž„
Nginxçš„æœ€å¤§ä¼˜åŠ¿åœ¨äºŽå¤„ç†é™æ€æ–‡ä»¶å’Œä»£ç†è½¬å‘åŠŸèƒ½ï¼Œæ”¯æŒ7å±‚è´Ÿè½½å‡è¡¡å’Œæ•…éšœéš”ç¦»ã€‚ åŠ¨é™åˆ†ç¦»æ˜¯æ¯ä¸ªç½‘ç«™å‘å±•åˆ°ä¸€å®šè§„æ¨¡ä¹‹åŽå¿…ç„¶çš„ç»“æžœã€‚
é™æ€è¯·æ±‚åˆ™åº”å½“æœ€å¥½å°†å…¶æ‹†åˆ†ï¼Œå¹¶å¯ç”¨ç‹¬ç«‹çš„åŸŸåï¼Œæ—¢ä¾¿äºŽç®¡ç†çš„éœ€è¦ï¼Œä¹Ÿä¾¿äºŽä»ŠåŽèƒ½å¤Ÿå¿«é€Ÿæ”¯æŒCDNã€‚å¦‚æžœä¸€å°Nginxæ€§èƒ½æ— æ³•æ»¡è¶³ï¼Œ
åˆ™å¯ä»¥è€ƒè™‘åœ¨Nginxå‰ç«¯æ·»åŠ LVSè´Ÿè½½å‡è¡¡ï¼Œæˆ–è€…F5ç­‰ç¡¬ä»¶è´Ÿè½½å‡è¡¡ï¼ˆè´¹ç”¨æ˜‚è´µï¼Œé€‚åˆåœŸè±ªå…¬å¸å•ä½ï¼‰ï¼Œç”±å¤šå°Nginxå…±åŒåˆ†æ‹…ç½‘ç«™è¯·æ±‚ã€‚
è¿˜å¯ä»¥è€ƒè™‘ç»“åˆVarnishæˆ–è€…Squidç¼“å­˜é™æ€æ–‡ä»¶å®žçŽ°ç±»ä¼¼CDNåŠŸèƒ½ã€‚æ–°ç‰ˆNginxç›®å‰å·²ç»æ”¯æŒç›´æŽ¥è¯»å†™Memcacheï¼Œå¯ä»¥ç¼–è¯‘å®‰è£…æ—¶å€™é€‰æ‹©
æ·»åŠ æ­¤ç±»æ¨¡å—ï¼Œä»Žè€ŒèŠ‚çœäº†è½¬äº¤ç»™PHPæˆ–è€…JPSç­‰åŠ¨æ€ç¨‹åºæœåŠ¡å™¨å¤„ç†æ—¶é—´ï¼Œæé«˜æ•ˆçŽ‡çš„åŒæ—¶ï¼Œå‡å°äº†åŠ¨æ€æœåŠ¡å™¨çš„è´Ÿè½½ã€‚

æ¥æºï¼š http://www.ttlsa.com/nginx/web-server-nginx-optimization/
```



## keepalived
```
Keepalivedä»‹ç»
keepalivedæ˜¯ä¸€ä¸ªç±»ä¼¼äºŽlayer3, 4, 5 äº¤æ¢æœºåˆ¶çš„è½¯ä»¶ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³æ—¶è¯´çš„ç¬¬3å±‚ã€ç¬¬4å±‚å’Œç¬¬5å±‚äº¤æ¢ã€‚Keepalivedçš„ä½œç”¨æ˜¯
æ£€æµ‹webæœåŠ¡å™¨çš„çŠ¶æ€ï¼Œå¦‚æžœæœ‰ä¸€å°webæœåŠ¡å™¨æ­»æœºï¼Œæˆ–å·¥ä½œå‡ºçŽ°æ•…éšœï¼ŒKeepalivedå°†æ£€æµ‹åˆ°ï¼Œå¹¶å°†æœ‰æ•…éšœçš„webæœåŠ¡å™¨ä»Žç³»ç»Ÿä¸­å‰”é™¤ï¼Œ
å½“webæœåŠ¡å™¨å·¥ä½œæ­£å¸¸åŽKeepalivedè‡ªåŠ¨å°†webæœåŠ¡å™¨åŠ å…¥åˆ°æœåŠ¡å™¨ç¾¤ä¸­ï¼Œè¿™äº›å·¥ä½œå…¨éƒ¨è‡ªåŠ¨å®Œæˆï¼Œä¸éœ€è¦äººå·¥å¹²æ¶‰ï¼Œéœ€è¦äººå·¥åšçš„åªæ˜¯
ä¿®å¤æ•…éšœçš„webæœåŠ¡å™¨
å®˜ç½‘åœ°å€ï¼šhttp://www.keepalived.org
keepalvedå®˜æ–¹ä½“ç³»ç»“æž„å›¾ï¼š

çŽ¯å¢ƒå‡†å¤‡
æ“ä½œç³»ç»Ÿï¼šCentOS6.6 64ä½ 2å°
Nginx-Master   10.0.0.60
Nginx-Backup   10.0.0.61
VIP                      10.0.0.62
æ³¨ï¼šæœªåšç‰¹åˆ«è¯´æ˜Žï¼Œä¸¤å°æœåŠ¡å™¨(ä¸¤ä¸ªèŠ‚ç‚¹)éƒ½ä¸€æ ·æ“ä½œ
å®‰è£…Nginx
ä½¿ç”¨ã€ŠOneinStackã€‹Nginxé€‰æ‹©yï¼Œå…¶ä½™n
å®‰è£…Keepalived
åœ¨Nginx-Masterã€Nginx-Backupï¼š
cd ~/oneinstack/src
wget http://www.keepalived.org/software/keepalived-1.2.22.tar.gz
tar xzf keepalived-1.2.22.tar.gz
cd keepalived-1.2.22
./configure --prefix=/usr/local/keepalived
make && make install
é…ç½®Keepalived
åœ¨Nginx-Masterã€Nginx-Backupï¼š
ln -s /usr/local/keepalived/etc/keepalived /etc/keepalived
ln -s /usr/local/keepalived/etc/rc.d/init.d/keepalived /etc/rc.d/init.d/keepalived
ln -s /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/keepalived
ln -s /usr/local/keepalived/sbin/keepalived /usr/bin/keepalived
chkconfig keepalived on
åœ¨Nginx-Masterä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œvi /etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   notification_email {
       admin@linuxeye.com     #è®¾ç½®æŠ¥è­¦é‚®ä»¶åœ°å€ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ªï¼Œæ¯è¡Œä¸€ä¸ªã€‚ éœ€å¼€å¯æœ¬æœºçš„sendmailæœåŠ¡
   }
   notification_email_from no-reply@linuxeye.com  #è®¾ç½®é‚®ä»¶çš„å‘é€åœ°å€
   smtp_server 127.0.0.1            #è®¾ç½®smtp serveråœ°å€
   smtp_connect_timeout 30    #è®¾ç½®è¿žæŽ¥smtp serverçš„è¶…æ—¶æ—¶é—´
   router_id LVS_DEVEL              #è¡¨ç¤ºè¿è¡ŒkeepalivedæœåŠ¡å™¨çš„ä¸€ä¸ªæ ‡è¯†ã€‚å‘é‚®ä»¶æ—¶æ˜¾ç¤ºåœ¨é‚®ä»¶ä¸»é¢˜çš„ä¿¡æ¯
}

vrrp_script chk_nginx {
    script "/usr/local/keepalived/sbin/check_nginx.sh"   #è¯¥è„šæœ¬æ£€æµ‹ngnixçš„è¿è¡ŒçŠ¶æ€ï¼Œå¹¶åœ¨nginxè¿›ç¨‹ä¸å­˜åœ¨æ—¶å°è¯•
    é‡æ–°å¯åŠ¨ngnixï¼Œå¦‚æžœå¯åŠ¨å¤±è´¥åˆ™åœæ­¢keepalivedï¼Œå‡†å¤‡è®©å…¶å®ƒæœºå™¨æŽ¥ç®¡ã€‚
    interval 2              #æ¯2sæ£€æµ‹ä¸€æ¬¡ï¼Œè®¾ç½®çš„æ—¶é—´è¦å¤§äºŽcheck_nginx.sh çš„è¿è¡Œæ—¶é—´ï¼Œå¦åˆ™ä¼šä¸€ç›´è¿è¡Œè€Œæ— æ³•ç”Ÿæ•ˆ
    weight 2               #æ£€æµ‹å¤±è´¥ï¼ˆè„šæœ¬è¿”å›žéž0ï¼‰åˆ™ä¼˜å…ˆçº§2
}

vrrp_instance VI_1 {
    state MASTER              #æŒ‡å®škeepalivedçš„è§’è‰²ï¼ŒMASTERè¡¨ç¤ºæ­¤ä¸»æœºæ˜¯ä¸»æœåŠ¡å™¨ï¼ŒBACKUPè¡¨ç¤ºæ­¤ä¸»æœºæ˜¯å¤‡ç”¨æœåŠ¡å™¨
    interface eth0              #æŒ‡å®šHAç›‘æµ‹ç½‘ç»œçš„æŽ¥å£
    virtual_router_id 55    #è™šæ‹Ÿè·¯ç”±æ ‡è¯†ï¼Œè¿™ä¸ªæ ‡è¯†æ˜¯ä¸€ä¸ªæ•°å­—ï¼ŒåŒä¸€ä¸ªvrrpå®žä¾‹ä½¿ç”¨å”¯ä¸€çš„æ ‡è¯†ã€‚å³åŒä¸€vrrp_instanceä¸‹
    ï¼ŒMASTERå’ŒBACKUPå¿…é¡»æ˜¯ä¸€è‡´çš„

    priority 100                  #å®šä¹‰ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œåœ¨åŒä¸€ä¸ªvrrp_instanceä¸‹ï¼ŒMASTERçš„ä¼˜å…ˆçº§å¿…é¡»å¤§
    äºŽBACKUPçš„ä¼˜å…ˆçº§
    advert_int 1            #è®¾å®šMASTERä¸ŽBACKUPè´Ÿè½½å‡è¡¡å™¨ä¹‹é—´åŒæ­¥æ£€æŸ¥çš„æ—¶é—´é—´éš”ï¼Œå•ä½æ˜¯ç§’
    authentication {        #è®¾ç½®éªŒè¯ç±»åž‹å’Œå¯†ç 
        auth_type PASS      #è®¾ç½®éªŒè¯ç±»åž‹ï¼Œä¸»è¦æœ‰PASSå’ŒAHä¸¤ç§
        auth_pass linuxeye  #è®¾ç½®éªŒè¯å¯†ç ï¼Œåœ¨åŒä¸€ä¸ªvrrp_instanceä¸‹ï¼ŒMASTERä¸ŽBACKUPå¿…é¡»ä½¿ç”¨ç›¸åŒçš„å¯†ç æ‰èƒ½æ­£å¸¸é€šä¿¡
    }
    virtual_ipaddress {     #è®¾ç½®è™šæ‹ŸIPåœ°å€ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ªè™šæ‹ŸIPåœ°å€ï¼Œæ¯è¡Œä¸€ä¸ª
        10.0.0.62
    }
    track_script {
        chk_nginx           #å¼•ç”¨VRRPè„šæœ¬ï¼Œå³åœ¨ vrrp_script éƒ¨åˆ†æŒ‡å®šçš„åå­—ã€‚å®šæœŸè¿è¡Œå®ƒä»¬æ¥æ”¹å˜ä¼˜å…ˆçº§ï¼Œå¹¶æœ€ç»ˆå¼•å‘ä¸»å¤‡åˆ‡æ¢ã€‚
    }
}
åœ¨Nginx-Backupä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œvi /etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   notification_email {
       admin@linuxeye.com     #è®¾ç½®æŠ¥è­¦é‚®ä»¶åœ°å€ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ªï¼Œæ¯è¡Œä¸€ä¸ªã€‚ éœ€å¼€å¯æœ¬æœºçš„sendmailæœåŠ¡
   }
   notification_email_from no-reply@linuxeye.com  #è®¾ç½®é‚®ä»¶çš„å‘é€åœ°å€
   smtp_server 127.0.0.1      #è®¾ç½®smtp serveråœ°å€
   smtp_connect_timeout 30    #è®¾ç½®è¿žæŽ¥smtp serverçš„è¶…æ—¶æ—¶é—´
   router_id LVS_DEVEL        #è¡¨ç¤ºè¿è¡ŒkeepalivedæœåŠ¡å™¨çš„ä¸€ä¸ªæ ‡è¯†ã€‚å‘é‚®ä»¶æ—¶æ˜¾ç¤ºåœ¨é‚®ä»¶ä¸»é¢˜çš„ä¿¡æ¯
}

vrrp_script chk_nginx {
    script "/usr/local/keepalived/sbin/check_nginx.sh"   #è¯¥è„šæœ¬æ£€æµ‹ngnixçš„è¿è¡ŒçŠ¶æ€ï¼Œå¹¶åœ¨nginxè¿›ç¨‹ä¸å­˜åœ¨æ—¶å°è¯•é‡æ–°
    å¯åŠ¨ngnixï¼Œå¦‚æžœå¯åŠ¨å¤±è´¥åˆ™åœæ­¢keepalivedï¼Œå‡†å¤‡è®©å…¶å®ƒæœºå™¨æŽ¥ç®¡ã€‚
    interval 2              #æ¯2sæ£€æµ‹ä¸€æ¬¡
    weight 2                #æ£€æµ‹å¤±è´¥ï¼ˆè„šæœ¬è¿”å›žéž0ï¼‰åˆ™ä¼˜å…ˆçº§2
}

vrrp_instance VI_1 {
    state BACKUP            #æŒ‡å®škeepalivedçš„è§’è‰²ï¼ŒMASTERè¡¨ç¤ºæ­¤ä¸»æœºæ˜¯ä¸»æœåŠ¡å™¨ï¼ŒBACKUPè¡¨ç¤ºæ­¤ä¸»æœºæ˜¯å¤‡ç”¨æœåŠ¡å™¨
    interface eth0          #æŒ‡å®šHAç›‘æµ‹ç½‘ç»œçš„æŽ¥å£
    virtual_router_id 55    #è™šæ‹Ÿè·¯ç”±æ ‡è¯†ï¼Œè¿™ä¸ªæ ‡è¯†æ˜¯ä¸€ä¸ªæ•°å­—ï¼ŒåŒä¸€ä¸ªvrrpå®žä¾‹ä½¿ç”¨å”¯ä¸€çš„æ ‡è¯†ã€‚å³åŒä¸€vrrp_instanceä¸‹ï¼Œ
    MASTERå’ŒBACKUPå¿…é¡»æ˜¯ä¸€è‡´çš„
    priority 50             #å®šä¹‰ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œåœ¨åŒä¸€ä¸ªvrrp_instanceä¸‹ï¼ŒMASTERçš„ä¼˜å…ˆçº§å¿…é¡»å¤§äºŽBACKUPçš„ä¼˜å…ˆçº§
    advert_int 1            #è®¾å®šMASTERä¸ŽBACKUPè´Ÿè½½å‡è¡¡å™¨ä¹‹é—´åŒæ­¥æ£€æŸ¥çš„æ—¶é—´é—´éš”ï¼Œå•ä½æ˜¯ç§’
    nopreempt               #è®¾ç½®nopreempté˜²æ­¢æŠ¢å èµ„æºï¼Œåªç”Ÿæ•ˆBACKUPèŠ‚ç‚¹
    authentication {        #è®¾ç½®éªŒè¯ç±»åž‹å’Œå¯†ç 
        auth_type PASS      #è®¾ç½®éªŒè¯ç±»åž‹ï¼Œä¸»è¦æœ‰PASSå’ŒAHä¸¤ç§
        auth_pass linuxeye  #è®¾ç½®éªŒè¯å¯†ç ï¼Œåœ¨åŒä¸€ä¸ªvrrp_instanceä¸‹ï¼ŒMASTERä¸ŽBACKUPå¿…é¡»ä½¿ç”¨ç›¸åŒçš„å¯†ç æ‰èƒ½æ­£å¸¸é€šä¿¡
    }
    virtual_ipaddress {     #è®¾ç½®è™šæ‹ŸIPåœ°å€ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ªè™šæ‹ŸIPåœ°å€ï¼Œæ¯è¡Œä¸€ä¸ª
        10.0.0.62
    }
    track_script {
        chk_nginx           #å¼•ç”¨VRRPè„šæœ¬ï¼Œå³åœ¨ vrrp_script éƒ¨åˆ†æŒ‡å®šçš„åå­—ã€‚å®šæœŸè¿è¡Œå®ƒä»¬æ¥æ”¹å˜ä¼˜å…ˆçº§ï¼Œå¹¶æœ€ç»ˆå¼•å‘ä¸»å¤‡åˆ‡æ¢ã€‚
    }
}
æ£€æµ‹è„šæœ¬ï¼Œvi /usr/local/keepalived/sbin/check_nginx.sh
#!/bin/bash
if [ "$(ps -ef | grep "nginx: master process"| grep -v grep )" == "" ];then
    #echo 1
    /etc/init.d/nginx start
    sleep 5

    if [ "$(ps -ef | grep "nginx: master process"| grep -v grep )" == "" ];then
        /etc/init.d/keepalived stop
        #echo 2
    fi
fi
è„šæœ¬åŠ ä¸Šå¯æ‰§è¡Œæƒé™
chmod +x /usr/local/keepalived/sbin/check_nginx.sh
éªŒè¯
service keepalived start  #å¯åŠ¨Nginx-Master
service keepalived start  #å¯åŠ¨Nginx-Backup
ip addr  #2å°æœåŠ¡å™¨åˆ†åˆ«æ‰§è¡Œï¼Œç»‘å®šè™šæ‹ŸIPåœ¨Nginx-Master
service keepalived stop  #åœæ­¢Nginx-Backup
ip addr  #2å°æœåŠ¡å™¨åˆ†åˆ«æ‰§è¡Œï¼Œç»‘å®šè™šæ‹ŸIPåœ¨Nginx-Backup
service keepalived start  #å†å¯åŠ¨Nginx-Backup
ip addr  #2å°æœåŠ¡å™¨åˆ†åˆ«æ‰§è¡Œï¼Œç»‘å®šè™šæ‹ŸIPåœ¨Nginx-Master
ä¸Šè¿°åˆ‡æ¢é»˜è®¤æµ‹è¯•ä¼šå¯¼è‡´çš„masterå’Œbackupä¹‹é—´æ¥å›žåˆ‡æ¢
é€šå¸¸å¦‚æžœmasteræœåŠ¡æ­»æŽ‰åŽbackupä¼šå˜æˆmasterï¼Œä½†æ˜¯å½“masteræœåŠ¡åˆå¥½äº†çš„æ—¶å€™masteræ­¤æ—¶ä¼šæŠ¢å VIPï¼Œè¿™æ ·å°±ä¼šå‘ç”Ÿä¸¤æ¬¡åˆ‡æ¢å¯¹ä¸šåŠ¡
ç¹å¿™çš„ç½‘ç«™æ¥è¯´æ˜¯ä¸å¥½çš„ã€‚æˆ‘ä»¬å¯ä»¥åœ¨é…ç½®æ–‡ä»¶åŠ å…¥nopreemptéžæŠ¢å ï¼Œä½†æ˜¯è¿™ä¸ªå‚æ•°åªèƒ½ç”¨äºŽstateä¸ºBACKUPï¼Œæ•…æˆ‘ä»¬åœ¨ç”¨HAçš„æ—¶å€™æœ€å¥½
MASTERå’Œbackupçš„stateéƒ½è®¾ç½®æˆBACKUPè®©å…¶é€šè¿‡priorityæ¥ç«žäº‰ã€‚
æ‹“å±•
å‡è®¾æˆ‘è¦é‡è£…è¿™2å°æœåŠ¡å™¨ï¼Œä½†æ˜¯è¿‡ç¨‹ä¸å®¹è®¸ä¸¢ä¸€ä¸ªåŒ…ï¼Œé€šå¸¸æƒ…å†µä¸‹å…ˆæ›¿æ¢backupï¼ŒæŠŠmasteråœæ­¢ï¼Œè®©vipæ¼‚ç§»åªbackupï¼Œæ›¿æ¢masterï¼Œ
ä½†æ˜¯åœ¨vipæ¼‚ç§»è¿‡ç¨‹å¯èƒ½ä¼šæœ‰ä¸¢2ä¸ªåŒ…ï¼Œå¦‚æžœé¿å…ä¸¢åŒ…ï¼Ÿ
æ–¹æ³•ï¼šæˆ‘ä»¬å¯ä»¥åœ¨masteræ›¿æ¢ä¹‹å‰ï¼Œåˆ©ç”¨iptableså°†æ•°æ®åŒ…è½¬å‘åˆ°backupï¼Œå†åœæ­¢master keepalived
iptables -F
iptables -t nat -I PREROUTING -i eth0 -j DNAT --to-destination 10.0.0.61
iptables -t nat -I POSTROUTING -o eth0 -j MASQUERADE
```



## nginx_upstream_check_module
    æä¾›è´Ÿè½½å‡è¡¡å™¨å†…èŠ‚ç‚¹çš„å¥åº·æ£€æŸ¥çš„ã€‚è¿™ä¸ªå°±æ˜¯æ·˜å®æŠ€æœ¯å›¢é˜Ÿå¼€å‘çš„ nginx æ¨¡å— nginx_upstream_check_moduleï¼Œ
    é€šè¿‡å®ƒå¯ä»¥ç”¨æ¥æ£€æµ‹åŽç«¯ realserver çš„å¥åº·çŠ¶æ€ã€‚å¦‚æžœåŽç«¯ realserver ä¸å¯ç”¨ï¼Œåˆ™æ‰€ä»¥çš„è¯·æ±‚å°±ä¸ä¼šè½¬å‘åˆ°è¯¥èŠ‚ç‚¹ä¸Šã€‚
    åœ¨æ·˜å®è‡ªå·±çš„ tengine ä¸Šæ˜¯è‡ªå¸¦äº†è¯¥æ¨¡å—çš„ï¼Œå¤§å®¶å¯ä»¥è®¿é—®æ·˜å®tengineçš„å®˜ç½‘æ¥èŽ·å–è¯¥ç‰ˆæœ¬çš„nginxï¼Œå®˜æ–¹åœ°å€ï¼š 
    http://tengine.taobao.org/ ã€‚

    ä¸‹è½½ nginx_upstream_check_moduleæ¨¡å—

    [root@localhost ~]# cd /usr/local/src
    wget https://codeload.github.com/yaoweibin/nginx_upstream_check_module/zip/master
    unzip master
    [root@localhost /usr/local/src]# ll -d nginx_upstream_check_module-master
    drwxr-xr-x. 6 root root 4096 Dec  1 02:28 nginx_upstream_check_module-master
    2ã€ä¸ºnginxæ‰“è¡¥ä¸

    [root@localhost /usr/local/src]# cd nginx-1.6.0 # è¿›å…¥nginxçš„æºç ç›®å½•
    [root@localhost nginx-1.6.0]# patch -p1 < ../nginx_upstream_check_module-master/check_1.5.12+.patch
    [root@localhost nginx-1.6.0]# ./configure --user=nginx --group=nginx --prefix=/usr/local/nginx-1.6.0 
    --with-http_ssl_module --with-openssl=/usr/local/src/openssl-0.9.8q --with-pcre=/usr/local/src/pcre-8.32 
    --add-module=/usr/local/src/nginx_concat_module/ --add-module=../nginx_upstream_check_module-master/
    make (æ³¨æ„ï¼šæ­¤å¤„åªmakeï¼Œç¼–è¯‘å‚æ•°éœ€è¦å’Œä¹‹å‰çš„ä¸€æ ·)
    [root@localhost nginx-1.6.0]# mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx-1.6.0.bak
    [root@localhost nginx-1.6.0]# cp ./objs/nginx /usr/local/nginx/sbin/
    [root@localhost nginx-1.6.0]# /usr/local/nginx/sbin/nginx -t  # æ£€æŸ¥ä¸‹æ˜¯å¦æœ‰é—®é¢˜
    [root@localhost nginx-1.6.0]# kill -USR2 `cat /usr/local/nginx/logs/nginx.pid`
    3ã€åœ¨nginx.confé…ç½®æ–‡ä»¶é‡Œé¢çš„upstreamåŠ å…¥å¥åº·æ£€æŸ¥ï¼Œå¦‚ä¸‹ï¼š

    upstream name {
           server 192.168.0.21:80;
           server 192.168.0.22:80;
           check interval=3000 rise=2 fall=5 timeout=1000 type=http;

    }
    ä¸Šé¢ é…ç½®çš„æ„æ€æ˜¯ï¼Œå¯¹nameè¿™ä¸ªè´Ÿè½½å‡è¡¡æ¡ç›®ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œæ¯ä¸ª3ç§’æ£€æµ‹ä¸€æ¬¡ï¼Œè¯·æ±‚2æ¬¡æ­£å¸¸åˆ™æ ‡è®° realserverçŠ¶æ€ä¸ºupï¼Œ
    å¦‚æžœæ£€æµ‹ 5 æ¬¡éƒ½å¤±è´¥ï¼Œåˆ™æ ‡è®° realserverçš„çŠ¶æ€ä¸ºdownï¼Œè¶…æ—¶æ—¶é—´ä¸º1ç§’ã€‚

    è¿™é‡Œåˆ—å‡º nginx_upstream_check_module æ¨¡å—æ‰€æ”¯æŒçš„æŒ‡ä»¤æ„æ€ï¼š


    Syntax: check interval=milliseconds [fall=count] [rise=count] [timeout=milliseconds] [default_down=true|false]
     [type=tcp|http|ssl_hello|mysql|ajp] [port=check_port]Default: å¦‚æžœæ²¡æœ‰é…ç½®å‚æ•°ï¼Œé»˜è®¤å€¼æ˜¯ï¼šinterval=30000 fall=5 
     rise=2 timeout=1000 default_down=true type=tcpContext: upstream
    è¯¥æŒ‡ä»¤å¯ä»¥æ‰“å¼€åŽç«¯æœåŠ¡å™¨çš„å¥åº·æ£€æŸ¥åŠŸèƒ½ã€‚

    æŒ‡ä»¤åŽé¢çš„å‚æ•°æ„ä¹‰æ˜¯ï¼š

      - intervalï¼šå‘åŽç«¯å‘é€çš„å¥åº·æ£€æŸ¥åŒ…çš„é—´éš”ã€‚
      - fall(fall_count): å¦‚æžœè¿žç»­å¤±è´¥æ¬¡æ•°è¾¾åˆ°fall_countï¼ŒæœåŠ¡å™¨å°±è¢«è®¤ä¸ºæ˜¯downã€‚
      - rise(rise_count): å¦‚æžœè¿žç»­æˆåŠŸæ¬¡æ•°è¾¾åˆ°rise_countï¼ŒæœåŠ¡å™¨å°±è¢«è®¤ä¸ºæ˜¯upã€‚
      - timeout: åŽç«¯å¥åº·è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ã€‚
      - default_down: è®¾å®šåˆå§‹æ—¶æœåŠ¡å™¨çš„çŠ¶æ€ï¼Œå¦‚æžœæ˜¯trueï¼Œå°±è¯´æ˜Žé»˜è®¤æ˜¯downçš„ï¼Œå¦‚æžœæ˜¯falseï¼Œå°±æ˜¯upçš„ã€‚é»˜è®¤å€¼æ˜¯trueï¼Œä¹Ÿå°±æ˜¯ä¸€
      å¼€å§‹æœåŠ¡å™¨è®¤ä¸ºæ˜¯ä¸å¯ç”¨ï¼Œè¦ç­‰å¥åº·æ£€æŸ¥åŒ…è¾¾åˆ°ä¸€å®šæˆåŠŸæ¬¡æ•°ä»¥åŽæ‰ä¼šè¢«è®¤ä¸ºæ˜¯å¥åº·çš„ã€‚
      - typeï¼šå¥åº·æ£€æŸ¥åŒ…çš„ç±»åž‹ï¼ŒçŽ°åœ¨æ”¯æŒä»¥ä¸‹å¤šç§ç±»åž‹
        - tcpï¼šç®€å•çš„tcpè¿žæŽ¥ï¼Œå¦‚æžœè¿žæŽ¥æˆåŠŸï¼Œå°±è¯´æ˜ŽåŽç«¯æ­£å¸¸ã€‚
        - ssl_helloï¼šå‘é€ä¸€ä¸ªåˆå§‹çš„SSL helloåŒ…å¹¶æŽ¥å—æœåŠ¡å™¨çš„SSL helloåŒ…ã€‚
        - httpï¼šå‘é€HTTPè¯·æ±‚ï¼Œé€šè¿‡åŽç«¯çš„å›žå¤åŒ…çš„çŠ¶æ€æ¥åˆ¤æ–­åŽç«¯æ˜¯å¦å­˜æ´»ã€‚
        - mysql: å‘mysqlæœåŠ¡å™¨è¿žæŽ¥ï¼Œé€šè¿‡æŽ¥æ”¶æœåŠ¡å™¨çš„greetingåŒ…æ¥åˆ¤æ–­åŽç«¯æ˜¯å¦å­˜æ´»ã€‚
        - ajpï¼šå‘åŽç«¯å‘é€AJPåè®®çš„CpingåŒ…ï¼Œé€šè¿‡æŽ¥æ”¶CpongåŒ…æ¥åˆ¤æ–­åŽç«¯æ˜¯å¦å­˜æ´»ã€‚
      - port: æŒ‡å®šåŽç«¯æœåŠ¡å™¨çš„æ£€æŸ¥ç«¯å£ã€‚ä½ å¯ä»¥æŒ‡å®šä¸åŒäºŽçœŸå®žæœåŠ¡çš„åŽç«¯æœåŠ¡å™¨çš„ç«¯å£ï¼Œæ¯”å¦‚åŽç«¯æä¾›çš„æ˜¯443ç«¯å£çš„åº”ç”¨ï¼Œä½ å¯ä»¥åŽ»æ£€æŸ¥
      80ç«¯å£çš„çŠ¶æ€æ¥åˆ¤æ–­åŽç«¯å¥åº·çŠ¶å†µã€‚é»˜è®¤æ˜¯0ï¼Œè¡¨ç¤ºè·ŸåŽç«¯serveræä¾›çœŸå®žæœåŠ¡çš„ç«¯å£ä¸€æ ·ã€‚è¯¥é€‰é¡¹å‡ºçŽ°äºŽTengine-1.4.0ã€‚
    Syntax: check_keepalive_requests request_numDefault: 1Context: upstream
    è¯¥æŒ‡ä»¤å¯ä»¥é…ç½®ä¸€ä¸ªè¿žæŽ¥å‘é€çš„è¯·æ±‚æ•°ï¼Œå…¶é»˜è®¤å€¼ä¸º1ï¼Œè¡¨ç¤ºTengineå®Œæˆ1æ¬¡è¯·æ±‚åŽå³å…³é—­è¿žæŽ¥ã€‚

    Syntax: check_http_send http_packetDefault: "GET / HTTP/1.0\r\n\r\n"Context: upstream
    è¯¥æŒ‡ä»¤å¯ä»¥é…ç½®httpå¥åº·æ£€æŸ¥åŒ…å‘é€çš„è¯·æ±‚å†…å®¹ã€‚ä¸ºäº†å‡å°‘ä¼ è¾“æ•°æ®é‡ï¼ŒæŽ¨èé‡‡ç”¨"HEAD"æ–¹æ³•ã€‚

    å½“é‡‡ç”¨é•¿è¿žæŽ¥è¿›è¡Œå¥åº·æ£€æŸ¥æ—¶ï¼Œéœ€åœ¨è¯¥æŒ‡ä»¤ä¸­æ·»åŠ keep-aliveè¯·æ±‚å¤´ï¼Œå¦‚ï¼š"HEAD / HTTP/1.1\r\nConnection: keep-alive\r\n\r\n"ã€‚ 
    åŒæ—¶ï¼Œåœ¨é‡‡ç”¨"GET"æ–¹æ³•çš„æƒ…å†µä¸‹ï¼Œè¯·æ±‚uriçš„sizeä¸å®œè¿‡å¤§ï¼Œç¡®ä¿å¯ä»¥åœ¨1ä¸ªintervalå†…ä¼ è¾“å®Œæˆï¼Œå¦åˆ™ä¼šè¢«å¥åº·æ£€æŸ¥æ¨¡å—è§†ä¸ºåŽç«¯æœåŠ¡å™¨æˆ–
    ç½‘ç»œå¼‚å¸¸ã€‚

    Syntax: check_http_expect_alive [ http_2xx | http_3xx | http_4xx | http_5xx ]Default: http_2xx | http_3xxContext: 
    upstream
    è¯¥æŒ‡ä»¤æŒ‡å®šHTTPå›žå¤çš„æˆåŠŸçŠ¶æ€ï¼Œé»˜è®¤è®¤ä¸º2XXå’Œ3XXçš„çŠ¶æ€æ˜¯å¥åº·çš„ã€‚

    Syntax: check_shm_size sizeDefault: 1MContext: http
    æ‰€æœ‰çš„åŽç«¯æœåŠ¡å™¨å¥åº·æ£€æŸ¥çŠ¶æ€éƒ½å­˜äºŽå…±äº«å†…å­˜ä¸­ï¼Œè¯¥æŒ‡ä»¤å¯ä»¥è®¾ç½®å…±äº«å†…å­˜çš„å¤§å°ã€‚é»˜è®¤æ˜¯1Mï¼Œå¦‚æžœä½ æœ‰1åƒå°ä»¥ä¸Šçš„æœåŠ¡å™¨å¹¶åœ¨é…ç½®çš„æ—¶å€™
    å‡ºçŽ°äº†é”™è¯¯ï¼Œå°±å¯èƒ½éœ€è¦æ‰©å¤§è¯¥å†…å­˜çš„å¤§å°ã€‚

    Syntax: check_status [html|csv|json]Default: check_status htmlContext: location
    æ˜¾ç¤ºæœåŠ¡å™¨çš„å¥åº·çŠ¶æ€é¡µé¢ã€‚è¯¥æŒ‡ä»¤éœ€è¦åœ¨httpå—ä¸­é…ç½®ã€‚

    åœ¨Tengine-1.4.0ä»¥åŽï¼Œä½ å¯ä»¥é…ç½®æ˜¾ç¤ºé¡µé¢çš„æ ¼å¼ã€‚æ”¯æŒçš„æ ¼å¼æœ‰: htmlã€csvã€ jsonã€‚é»˜è®¤ç±»åž‹æ˜¯htmlã€‚

    ä½ ä¹Ÿå¯ä»¥é€šè¿‡è¯·æ±‚çš„å‚æ•°æ¥æŒ‡å®šæ ¼å¼ï¼Œå‡è®¾â€˜/statusâ€™æ˜¯ä½ çŠ¶æ€é¡µé¢çš„URLï¼Œ formatå‚æ•°æ”¹å˜é¡µé¢çš„æ ¼å¼ï¼Œæ¯”å¦‚ï¼š

    /status?format=html
    /status?format=csv
    /status?format=json
    åŒæ—¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡statuså‚æ•°æ¥èŽ·å–ç›¸åŒæœåŠ¡å™¨çŠ¶æ€çš„åˆ—è¡¨ï¼Œæ¯”å¦‚ï¼š

    /status?format=html&status=down
    /status?format=csv&status=up
    ä¸‹é¢æ˜¯ä¸€ä¸ªçŠ¶æ€ä¹Ÿé…ç½®çš„èŒƒä¾‹ï¼š

    http {
          server {
           location /nstatus {
             check_status;
             access_log off;
             #allow IP;         #deny all;       }
          }
    }
    é…ç½®å®Œæ¯•åŽï¼Œé‡å¯nginxã€‚æ­¤æ—¶é€šè¿‡è®¿é—®å®šä¹‰å¥½çš„è·¯å¾„ï¼Œå°±å¯ä»¥çœ‹åˆ°å½“å‰ realserver å®žæ—¶çš„å¥åº·çŠ¶æ€å•¦ã€‚æ•ˆæžœå¦‚ä¸‹å›¾ï¼š 
    realserver éƒ½æ­£å¸¸çš„çŠ¶æ€ï¼š

    wKiom1SZZXKQcPJTAAFnMqUEfBo238.jpg

    ä¸€å° realserver æ•…éšœçš„çŠ¶æ€ï¼š

    wKioL1SZZivDAzdWAAGTyIK9cS8558.jpgOKï¼Œä»¥ä¸Šnginx_upstream_check_moduleæ¨¡å—çš„ç›¸å…³ä¿¡æ¯ï¼Œæ›´å¤šçš„ä¿¡æ¯å¤§å®¶å¯ä»¥åŽ»è¯¥æ¨¡å—çš„æ·˜å®
    tengineé¡µé¢å’Œgithubä¸Šè¯¥é¡¹ç›®é¡µé¢åŽ»æŸ¥çœ‹ï¼Œä¸‹é¢æ˜¯è®¿é—®åœ°å€ï¼š

    http://tengine.taobao.org/document_cn/http_upstream_check_cn.html

    https://github.com/yaoweibin/nginx_upstream_check_module

    åœ¨ç”Ÿäº§çŽ¯å¢ƒçš„å®žæ–½åº”ç”¨ä¸­ï¼Œéœ€è¦æ³¨æ„çš„æœ‰ 2 ç‚¹ï¼š

    1ã€ä¸»è¦å®šä¹‰å¥½typeã€‚ç”±äºŽé»˜è®¤çš„typeæ˜¯tcpç±»åž‹ï¼Œå› æ­¤å‡è®¾ä½ æœåŠ¡å¯åŠ¨ï¼Œä¸ç®¡æ˜¯å¦åˆå§‹åŒ–å®Œæ¯•ï¼Œå®ƒçš„ç«¯å£éƒ½ä¼šèµ·æ¥ï¼Œæ‰€ä»¥æ­¤æ—¶å‰æ®µè´Ÿè½½å‡è¡¡å™¨
    ä¸ºè®¤ä¸ºè¯¥æœåŠ¡å·²ç»å¯ç”¨ï¼Œå…¶å®žæ˜¯ä¸å¯ç”¨çŠ¶æ€ã€‚

    2ã€æ³¨æ„check_http_sendå€¼çš„è®¾å®šã€‚ç”±äºŽå®ƒçš„é»˜è®¤å€¼æ˜¯"GET / HTTP/1.0\r\n\r\n"ã€‚å‡è®¾ä½ çš„åº”ç”¨æ˜¯é€šè¿‡http://ip/nameè®¿é—®çš„ï¼Œé‚£ä¹ˆ
    è¿™é‡Œä½ çš„ check_http_sendå€¼å°±éœ€è¦æ›´æ”¹ä¸º "GET /name HTTP/1.0\r\n\r\n"æ‰å¯ä»¥ã€‚é’ˆå¯¹é‡‡ç”¨é•¿è¿žæŽ¥è¿›è¡Œæ£€æŸ¥çš„ï¼Œ è¿™é‡Œå¢žåŠ keep-alive
    è¯·æ±‚ å¤´ï¼Œå³"HEAD /name HTTP/1.1\r\nConnection: keep-alive\r\n\r\n"ã€‚å¦‚æžœä½ åŽç«¯çš„tomcatæ˜¯åŸºäºŽåŸŸåçš„å¤šè™šæ‹Ÿæœºï¼Œæ­¤æ—¶ä½ éœ€è¦é€š
    è¿‡ check_http_sendå®šä¹‰hostï¼Œä¸ç„¶æ¯æ¬¡è®¿é—®éƒ½æ˜¯å¤±è´¥ï¼ŒèŒƒä¾‹ï¼šcheck_http_send "GET /mobileapi HTTP/1.0\r\n HOST www.redhat.sx
    \r\n\r\n";

    ä¸‰ã€ ngx_http_healthcheck_moduleæ¨¡å—

    é™¤äº†ä¸Šé¢ä¸¤ä¸ªæ¨¡å—ï¼Œnginxå®˜æ–¹åœ¨æ—©æœŸçš„æ—¶å€™è¿˜æä¾›äº†ä¸€ä¸ªngx_http_healthcheck_module  æ¨¡å—ç”¨æ¥è¿›è¡Œ nginxåŽç«¯èŠ‚ç‚¹çš„å¥åº·æ£€æŸ¥ã€‚
    nginx_upstream_check_moduleæ¨¡å—å°±æ˜¯å‚ç…§ è¯¥æ¨¡å—çš„è®¾è®¡ç†å¿µè¿›è¡Œå¼€å‘çš„ï¼Œå› æ­¤åœ¨ä½¿ç”¨å’Œæ•ˆæžœä¸Šéƒ½å¤§åŒå°å¼‚ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ 
    ngx_http_healthcheck_module  æ¨¡å—ä»…ä»…æ”¯æŒnginxçš„1.0.0ç‰ˆæœ¬ï¼Œ1.1.0ç‰ˆæœ¬ä»¥åŽéƒ½ä¸æ”¯æŒäº†ï¼å› æ­¤ï¼Œå¯¹äºŽç›®å‰å¸¸è§çš„ç”Ÿäº§çŽ¯å¢ƒä¸Šéƒ½ä¸
    ä¼šåŽ»ç”¨äº†ï¼Œè¿™é‡Œä»…ä»…ç•™ä¸ªçºªå¿µï¼Œç»™å¤§å®¶ä»‹ç»ä¸‹è¿™ä¸ªæ¨¡å—ï¼

    å…·ä½“çš„ä½¿ç”¨æ–¹æ³•ï¼Œè¿™é‡Œå¯ä»¥è´´å‡ºå‡ ç¯‡é è°±çš„åšæ–‡åœ°å€ä»¥åŠå®˜æ–¹åœ°å€ï¼š

    http://wiki.nginx.org/HttpHealthcheckModule

    https://github.com/cep21/healthcheck_nginx_upstreams/blob/master/README

    OKï¼

    ä»¥ä¸Šå°±æ˜¯æœ¬æ–‡çš„å†…å®¹ï¼Œå¸Œæœ›èƒ½å¤Ÿå¯¹51åšå‹æœ‰æ‰€å¸®åŠ©ï¼


    æ¥æºï¼š http://www.tuicool.com/articles/vuiQry



## è™šæ‹Ÿä¸»æœº
```
åŸºäºŽåŸŸåçš„è™šæ‹Ÿä¸»æœº
server {
    listen 80;
    server_name www.example.com;
    ...
}
server {
    listen 80;
    server_name www.test.com;
    ...
}

åŸºäºŽipçš„è™šæ‹Ÿä¸»æœº
server {
    listen 10.0.0.88:80;
    root 88.com;
    index index.html;
}
server {
    listen 10.0.0.87:80;
    root 87.com;
    index index.html;
}
```



## æ­£å‘ä»£ç†
```
server {
 listen 8093;
 location / {
 resolver 218.85.157.99 218.85.152.99; #dns
 resolver_timeout 30s;
 proxy_pass http://$host$request_uri;
 }
 access_log  /var/log/proxy-aceess.log;      
}

å› ä¸ºNginxä¸æ”¯æŒCONNECTï¼Œæ‰€ä»¥æ— æ³•æ­£å‘ä»£ç†Httpsç½‘ç«™(å¦‚ï¼šç½‘ä¸Šé“¶è¡Œï¼ŒGmail)   ä½†æ˜¯squidæ”¯æŒCONNECT
curl http://www.baidu.com/  -x 172.29.0.70:8093
curl https://www.baidu.com  -x 10.191.174.31:3128  squid

rsyncä»£ç†è®¾ç½®
export RSYNC_PROXY="192.168.0.123:8080"
http/ftpä»£ç†è®¾ç½®
export http_proxy="192.168.0.123:8080"
export FTP_PROXY="192.168.0.123:8080"
export HTTP_PROXY="192.168.0.123:8080"
export ftp_proxy="192.168.0.123:8080"
å¯¹äºŽwgetå¯ä»¥å•ç‹¬å»ºç«‹.wgetrc
http-proxy = "192.168.0.123:8080"
ftp-proxy = "192.168.0.123:8080"
å¯¹äºŽå¸¸ç”¨ä»£ç†çš„ï¼Œå¯ä»¥å†™å…¥/etc/profileæˆ–è€…~/.bash_profile
ä¸´æ—¶å–æ¶ˆä»£ç†å¯ä»¥unset

=======================
yumä½¿ç”¨
export http_proxy="
http://172.29.0.70:8093
" åŽç›´æŽ¥yum install
unset http_proxy (å–æ¶ˆ)
========================

pipä½¿ç”¨
pip --proxy http://172.29.0.70:8093 install -r pip_requirements.txt -i  http://pypi.douban.com/simple


rsyncä½¿ç”¨squid
yum install squid
vim /etc/squid/squid.conf
acl localnet src 10.191.173.0/24
acl SSL_ports port 443 563 873
acl Safe_ports port 873

/etc/init.d/squid start

å®¢æˆ·ç«¯é…ç½®å…¬ç½‘dns
export RSYNC_PROXY="192.168.0.123:3128"
```



## 404è·³è½¬
nginx+php ä½¿ç”¨çš„æ—¶å€™ç»å¸¸éœ€è¦ä¼ªé™æ€ï¼Œä¸€èˆ¬å¤§å®¶éƒ½æ‰‹åŠ¨è®¾ç½®ã€‚é‚£æœ‰æ²¡æœ‰åŠžæ³•è®© nginx è‡ªåŠ¨è¡¥å…¨è·¯å¾„å‘¢ï¼Ÿ  
è¿™ä¸¤å¤©æŠ˜è…¾å¾ˆä¹…ï¼Œæ‰å®žçŽ°äº†è¿™æ ·ä¸€ä¸ªåŠŸèƒ½ï¼š  
è¯·æ±‚ /a/b/c  
è‹¥æ–‡ä»¶ä¸å­˜åœ¨ï¼ŒæŸ¥æ‰¾ /a/b/index.phpï¼Œ/c ä½œä¸º PATH\_INFOï¼›  
è‹¥æ–‡ä»¶ä¸å­˜åœ¨ï¼ŒæŸ¥æ‰¾ /a/index.phpï¼Œ/b/c ä½œä¸º PATH\_INFOï¼›  
è‹¥æ–‡ä»¶ä¸å­˜åœ¨ï¼ŒæŸ¥æ‰¾ /index.phpï¼Œ/a/b/c ä½œä¸º PATH\_INFOï¼›  
è‹¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿”å›ž 404.

è™½ç„¶è¿™ç§æŸè€—æ€§èƒ½çš„è¡Œä¸ºä¸é€‚åˆéƒ¨ç½²ï¼Œä½†åœ¨æœ¬æœºè°ƒè¯•çš„æ—¶å€™è¿˜æ˜¯èƒ½å¤Ÿå¸¦æ¥æ–¹ä¾¿çš„ ðŸ™‚

server ç«¯åº”æœ‰å¦‚ä¸‹ä»£ç ï¼Œå…¶ä»–éƒ¨åˆ†ä½¿ç”¨è‡ªå·±çš„é…ç½®ï¼š

index index.php index.html index.htm;

```
location / {
    set $path $request_uri;
    set $path_info "";

    try_files $uri $uri/ @404;
}

location @404 {
    if ($path ~ ^(.*)(/.+)$) {
        set $path $1/index.php;
        set $path_info $2;
        rewrite .* $path last;
    }
    return 404;
}

location ~ .+.php($|/) {
    fastcgi_split_path_info ^(.+.php)(/.+)$;
    if ($path_info !~ .*) {
        set $path_info $fastcgi_path_info;
    }
    try_files $fastcgi_script_name @404php;

    fastcgi_param PATH_INFO $path_info;

    fastcgi_index index.php;
    include fastcgi.conf;

    fastcgi_pass unix:/usr/local/var/run/php-fpm.sock;
    fastcgi_connect_timeout 60;
    fastcgi_send_timeout 300;
    fastcgi_read_timeout 300;
}

location @404php {
    if ($path = /index.php) {
        return 404;
    }

    if ($path ~ ^(.*)(/.+)/index.php$) {
        set $path_info $2;
        set $path $1/index.php;
        rewrite .* $path last;
    }
    return 404;
}
```



## yumä»£ç†ç¼“å­˜
```
# nginx.conf log_format æ·»åŠ   "$upstream_cache_status" å‘½ä¸­çŠ¶æ€

proxy_cache_path /data/cache levels=1:2 keys_zone=rpm-cache:50m max_size=20g inactive=365d use_temp_path=off; 
proxy_cache_path /data/repo levels=1:2 keys_zone=repo-cache:50m max_size=1g inactive=1d use_temp_path=off; 
proxy_redirect off;
proxy_connect_timeout 30;
proxy_cache_valid  200 304 302 24h;
proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504; #åŽç«¯è¶…æ—¶ä½¿ç”¨ç¼“å­˜çš„æ•°æ®
add_header X-Cache-Status $upstream_cache_status;
server_tokens off;

server {
    listen 80;

    root html;
    index index.html index.htm index.php;
    location / {
            return 404;
    }

    location ~ (\.iso|\.filez|\.dirtree|\.png|\.gif)$ {
            return 403;
    }

    location /itv/ {
        alias /data/itv/;
    }

    location /base/ {
        set $key rpm-cache;
        if ( $uri ~* repodata ){
            set $key repo-cache;
        }
        proxy_pass http://mirrors.aliyun.com/centos/;
        proxy_cache $key;
    }

    location /epel/ {
                set $key rpm-cache;
                if ( $uri ~* repodata ){
                        set $key repo-cache;
                }
                proxy_pass http://mirrors.aliyun.com/epel/;
                proxy_cache $key;
        }
}


repoæ–‡ä»¶
[iTV]
name=iTV
baseurl=http://192.168.41.21/itv/$releasever/$basearch/
enabled=1
gpgcheck=0

[iTV-base]
name=iTV-base
baseurl=http://192.168.41.21/base/$releasever/os/$basearch/
enabled=1
gpgcheck=0


[iTV-updates]
name=iTV-updates
baseurl=http://192.168.41.21/base/$releasever/updates/$basearch/
enabled=1
gpgcheck=0

[iTV-extras]
name=iTV-extras
baseurl=http://192.168.41.21/base/$releasever/extras/$basearch/
enabled=1
gpgcheck=0

[iTV-epel]
name=iTV-epel
baseurl=http://192.168.41.21/epel/$releasever/$basearch/
enabled=1
gpgcheck=0
```



## sslå’Œh2
```
# rpm -ivh https://nginx.org/packages/rhel/7/x86_64/RPMS/nginx-1.14.0-1.el7_4.ngx.x86_64.rpm
# wget https://raw.githubusercontent.com/Neilpang/acme.sh/master/acme.sh
# sh acme.sh --issue -d *.zxdr.tk -d zxdr.tk --dns --yes-I-know-dns-manual-mode-enough-go-ahead-please # add dns record
# sh acme.sh --issue -d *.zxdr.tk -d zxdr.tk --dns --yes-I-know-dns-manual-mode-enough-go-ahead-please --renew
user  nobody;
worker_processes  auto;
events {
    use epoll;
    accept_mutex off;
    worker_connections  65536;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    gzip  on;
    server_tokens  off;
    
    map $http_upgrade $connection_upgrade {
	default upgrade;
	'' close;
    }
    #server { listen 80 default; location / { root html; } }
    server {
	listen 0.0.0.0:443 ssl http2 default;
	ssl on;
	ssl_certificate /root/.acme.sh/*.zxdr.tk/fullchain.cer;
	ssl_certificate_key /root/.acme.sh/*.zxdr.tk/*.zxdr.tk.key;
	ssl_session_timeout 1d;
    	ssl_session_cache shared:SSL:50m;
    	ssl_session_tickets off;
	ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
	ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';
    	ssl_prefer_server_ciphers on;
	add_header Strict-Transport-Security max-age=15768000;
	ssl_stapling on;
    	ssl_stapling_verify on;
	resolver 8.8.8.8;

	location / {
                alias /tmp/down/;
                autoindex on;
		charset utf-8;
		autoindex_localtime on;
    		autoindex_exact_size off;
		add_before_body /.nginx/header.html;
                add_after_body /.nginx/footer.html;
        }

	location /co/ {
		proxy_pass http://127.0.0.1:9090;
        	proxy_http_version 1.1;
        	proxy_buffering off;
        	proxy_set_header X-Real-IP  $remote_addr;
        	proxy_set_header Host $host;
        	proxy_set_header X-Forwarded-For $remote_addr;
	        proxy_set_header Upgrade $http_upgrade;
        	proxy_set_header Connection $connection_upgrade;
        	proxy_set_header Origin http://$host;
        	#gzip off;
	}

	location /test/ {
		proxy_redirect off;
		proxy_pass http://127.0.0.1:7923;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";
		proxy_set_header Host $http_host;
		proxy_intercept_errors on;
  	}
	location /stat {
                stub_status on;
        }
        error_page  400 500 502 503 504  /50x.html;
        location = /50x.html {
            	root   /usr/share/nginx/html;
        }
    }
}
```



## è·¨åŸŸ
```
add_header Access-Control-Allow-Origin *;
location / {
    if ($request_method = 'OPTIONS') { 
        add_header Access-Control-Allow-Origin *; 
        add_header Access-Control-Allow-Methods GET,POST,PUT,DELETE,OPTIONS;
        return 204; 
    }
    index index.php;
    try_files $uri @rewriteapp;
}
```



## openresty
https://openresty.org/package/centos/openresty.repo

```
[openresty]
name=Official OpenResty Open Source Repository for CentOS
baseurl=https://openresty.org/package/centos/$releasever/$basearch
skip_if_unavailable=False
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://openresty.org/package/pubkey.gpg
enabled=1
enabled_metadata=1
```



## proxyèŽ·å–çœŸå®žip
```
upstream www.264.cn {
    ip_hash;
    server serving-server1.com:80;
    server serving-server2.com:80;
}
server {
    listen www.264.cn:80;
    server_name www.264.cn;

    location / {
        proxy_pass http://www.264.cn;
    }

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

}
åœ¨nginxçš„é…ç½®æ–‡ä»¶ä¸­åŠ å…¥ä¸‹é¢ä¸‰ä¸ªæŒ‡ä»¤ï¼Œè¿™æ ·åŽç«¯phpå°±å¯ä»¥ä½¿ç”¨$_SERVER['HTTP_X_REAL_IP']èŽ·å–åˆ°è®¿å®¢çš„ipã€‚


proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

å¦‚æžœä½ æƒ³ä½¿ç”¨$_SERVER['REMOTE_ADDR']ï¼Œä¸æƒ³ä¿®æ”¹ä»£ç ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ä¿®æ”¹REMOTE_ADDRçš„å€¼æ¥å®žçŽ°ã€‚

ç»è¿‡å¤šå±‚ä»£ç†åŽ $http_x_forwared_for ä¼šå«æœ‰å¤šä¸ªipï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªipæ˜¯å®¢æˆ·ç«¯çš„ipï¼ŒREMOTE_ADDRåªèƒ½æ˜¯å®¢æˆ·ç«¯çš„ipï¼Œ
æ‰€ä»¥å¯ä»¥ç”¨æ­£åˆ™æå– $http_x_forwarded_forçš„ç¬¬ä¸€ä¸ªipç»™REMOTE_ADDR:


  set $realip $remote_addr;
  if ($http_x_forwarded_for ~ "^(\d+\.\d+\.\d+\.\d+)") {
    set $realip $1;
  }
  fastcgi_param REMOTE_ADDR $realip;
  
```

## php-fpm
```
yum install php-fpm
systemctl start php-fpm

        root /var/www;
        location / {
              index index.php;
        }
        location ~ \.php$ {
              fastcgi_pass 127.0.0.1:9000;
              fastcgi_index index.php;
              fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              include fastcgi_params;
        }
```